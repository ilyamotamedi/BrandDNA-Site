<!DOCTYPE html>
<html lang="en">
<head>
    <script src="config.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brand DNA - Storyboarding V2</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Unbounded:wght@200..900&display=swap">
    <link rel="stylesheet" href="styles.css">
    <script src="nav-template.js"></script>
    <style>
        /* Custom styles for storyboard-v2 */
        .storyboard-results-container {
            width: 100%;
            max-width: 1400px;
            margin: 2rem auto;
            position: relative;
        }

        .storyboard-grid, .storyboard-grid-row2 {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 20px;
            position: relative; /* Added for positioning the add buttons */
        }
        
        .storyboard-grid-row2 {
            margin-top: 20px;
        }
        
        @media (max-width: 1200px) {
            .storyboard-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .storyboard-grid-row2 {
                grid-template-columns: repeat(2, 1fr);
                width: 100%;
            }
        }
        
        @media (max-width: 768px) {
            .storyboard-grid, 
            .storyboard-grid-row2 {
                grid-template-columns: 1fr;
                width: 100%;
            }
        }

        .storyboard-card {
            background: white;
            border-radius: 16px;
            padding: 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border: 1px solid;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            height: 100%; /* Ensure all cards have the same height */
        }

        .card-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 0 0 0.5rem 0;
        }

        .card-footer {
            padding: 0.5rem 1rem;
            border-top: 1px solid #f0f0f0;
            margin-top: auto; /* Push to bottom */
        }

        .storyboard-image {
            width: 100%;
            height: auto;
            border-radius: 0;
            display: block;
        }

        .storyboard-image-loading {
            width: 100%;
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f1f1f1;
            color: #666;
            border-radius: 4px;
        }

        .brand-card-title {
            margin-top: 0;
            margin-bottom: 0.5rem;
            padding: 0 1rem;
            font-size: 1rem;
        }

        .brand-card-body {
            padding: 0 1rem;
            font-size: 0.85rem;
            color: #444;
            line-height: 1.4;
            max-height: none;
            overflow-y: auto;
            flex-grow: 1; /* Allow the body to grow */
        }
        
        .creator-select-container {
            display: flex;
            gap: 1rem;
            margin-bottom: 0rem;
            margin-top: 1rem;
            align-items: center;
            max-width: 800px;
            width: 100%;
        }

        .creator-select-box {
            flex-grow: 1;
            position: relative;
            border: 1px solid #ddd;
            border-radius: 24px;
            background: white;
            overflow: visible;
            display: flex;
            align-items: center;
        }

        .creator-input {
            width: 100%;
            padding: 0.8rem 1.5rem;
            font-family: 'Unbounded', sans-serif;
            border: none;
            outline: none;
            background: transparent;
        }

        .creator-dropdown-arrow {
            width: 28px;
            height: 28px;
            cursor: pointer;
            transition: transform 0.2s ease;
            padding: 0px;
            opacity: 0.7;
            margin-right: 1rem;
        }

        .creator-dropdown-arrow:hover {
            opacity: 1.0;
        }

        .creator-dropdown-menu {
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            width: 100%;
            max-height: 16.5rem;
            overflow-y: auto;
            background: white;
            border: 1px solid #ddd;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            z-index: 1000;
            display: none;
        }

        .creator-dropdown-menu.active {
            display: block;
        }

        .creator-dropdown-item {
            padding: 1rem 1.5rem;
            font-family: 'Unbounded', sans-serif;
            font-size: 0.9rem;
            color: #26201F;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            height: 3.2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .image-wrapper {
            position: relative;
            width: 100%;
            margin-bottom: 0;
        }

        .download-button {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background-color: rgba(0, 0, 0, 0.2);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s ease;
            padding: 6px;
            z-index: 1;
        }

        .download-button:hover {
            background-color: rgba(0, 0, 0, 0.3);
        }

        .download-button svg {
            width: 20px;
            height: 20px;
        }

        .scene-number {
            padding: 0 1rem;
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 0.25rem;
            margin-top: 0.5rem;
        }

        .prompt-section {
            padding: 0 1rem;
            margin-top: 0.5rem;
            display: none;
        }

        .prompt-button {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            font-family: 'Unbounded', sans-serif;
            font-size: 0.8rem;
            padding: 0.5rem 0;
        }

        .prompt-button:hover {
            color: #000;
        }

        .chevron-icon {
            transition: transform 0.2s ease;
        }

        .prompt-button.expanded .chevron-icon {
            transform: rotate(180deg);
        }

        .prompt-content {
            font-size: 0.85rem;
            color: #666;
            background: #f8f8f8;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 0.5rem;
            white-space: pre-wrap;
            display: none;
        }

        .search-row {
            display: flex;
            gap: 1rem;
            max-width: 800px;
            width: 100%;
            margin-bottom: 1rem;
        }

        .search-row + .search-row {
            margin-top: 0rem;
        }

        .integration-select {
            width: 180px;
            padding: 0.8rem 1.5rem;
            font-family: 'Unbounded', sans-serif;
            border: 1px solid #ddd;
            border-radius: 24px;
            background: white;
            outline: none;
            cursor: pointer;
            font-size: 0.9rem;
            appearance: none;
            background-image: url('/icons/drop_down.svg');
            background-repeat: no-repeat;
            background-position: calc(100% - 1rem) center;
            background-size: 28px;
        }

        .integration-select option[value=""] {
            color: #999;
        }

        .integration-select.placeholder {
            color: #999;
        }

        .integration-select:not(.placeholder) {
            color: #26201F;
        }

        .regenerate-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            font-family: 'Unbounded', sans-serif;
            font-size: 0.8rem;
            padding: 0;
            margin: 0;
            transition: all 0.2s ease;
            width: 100%;
            justify-content: center;
        }

        .regenerate-btn:hover {
            color: #000;
        }

        .regenerate-icon {
            width: 20px;
            height: 20px;
            transition: transform 0.3s ease;
        }

        .regenerate-btn:hover .regenerate-icon {
            transform: rotate(180deg);
        }

        .feedback-container {
            padding: 1rem;
            margin-top: 0;
            display: none;
            border-top: 1px solid #f0f0f0;
            background-color: #f9f9f9;
        }

        .feedback-textarea {
            width: 100%;
            min-height: 80px;
            padding: 0.8rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-family: 'Unbounded', sans-serif;
            font-size: 0.8rem;
            resize: vertical;
            margin-bottom: 1rem;
        }

        .feedback-actions {
            display: flex;
            justify-content: space-between;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .submit-feedback-btn, .cancel-feedback-btn {
            padding: 0.5rem 1rem;
            border-radius: 16px;
            font-family: 'Unbounded', sans-serif;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
            flex: 1;
        }

        .submit-feedback-btn {
            background: linear-gradient(90deg, #F53151 0%, #F742BD 100%);
            color: white;
            border: none;
        }

        .submit-feedback-btn:hover {
            opacity: 0.9;
        }

        .cancel-feedback-btn {
            background: #f5f5f5;
            border: 1px solid #ddd;
        }

        .cancel-feedback-btn:hover {
            background: #e9e9e9;
        }

        .regenerating-indicator {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            z-index: 20;
            border-radius: 8px;
        }

        .regenerating-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Add scene button styles */
        .add-scene-button {
            position: absolute;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.7);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            transform: translate(-50%, -50%);
            transition: background 0.3s ease;
            opacity: 0; /* Hide by default */
        }

        .add-scene-button:hover {
            background: linear-gradient(90deg, #F53151 0%, #F742BD 100%);
        }

        /* Show buttons when hovering over the container */
        .storyboard-results-container:hover .add-scene-button {
            opacity: 1;
        }

        /* Keep button visible when hovering directly over it */
        .add-scene-button:hover {
            opacity: 1;
        }

        .add-scene-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            z-index: 1000;
        }

        .popup-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
        }

        .popup-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 2rem;
            border-radius: 8px;
            width: 400px;
            max-width: 90%;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        .popup-content h3 {
            margin-top: 0;
            margin-bottom: 1rem;
            color: #333;
        }

        .popup-content textarea {
            width: 100%;
            min-height: 120px;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 1rem;
            font-family: inherit;
            resize: vertical;
        }

        .popup-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }

        .add-scene-confirm-btn {
            background: linear-gradient(90deg, #F53151 0%, #F742BD 100%);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 24px;
            cursor: pointer;
            font-weight: 500;
        }

        .add-scene-cancel-btn {
            background: #f1f1f1;
            color: #333;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 24px;
            cursor: pointer;
        }

        .regenerate-ideas-btn:active {
            transform: translateY(0);
        }

        /* Review Storyboard Button Styles */
        .review-storyboard-btn {
            display: none; /* Initially hidden */
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            background: transparent;
            color: #F53151;
            border: none;
            position: relative;
            padding: 0.8rem 1.5rem;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
            margin: 2rem auto;
            width: fit-content;
            border-radius: 9999px;
            z-index: 1;
        }

        .review-storyboard-btn::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 9999px;
            padding: 2px;
            background: linear-gradient(90deg, #F53151, #F742BD);
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            z-index: -1;
        }

        .review-storyboard-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .review-storyboard-btn:active {
            transform: translateY(0);
        }

        .review-storyboard-btn.loading {
            pointer-events: none;
            opacity: 0.7;
        }

        .review-storyboard-btn .loading-spinner {
            display: none;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(245, 49, 81, 0.3);
            border-radius: 50%;
            border-top-color: #F53151;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        .review-storyboard-btn.loading .loading-spinner {
            display: inline-block;
        }

        /* Warning Icon Styles */
        .warning-icon {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 24px;
            height: 24px;
            z-index: 5;
            cursor: pointer;
        }

        .warning-icon svg {
            fill: #F53151;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
        }

        .warning-tooltip {
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            width: 250px;
            font-size: 0.85rem;
            color: #26201F;
            display: none;
            z-index: 10;
        }

        .warning-icon:hover .warning-tooltip {
            display: block;
        }

        /* Context Menu Styles */
        .context-menu {
            position: fixed;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            padding: 0.5rem 0;
            z-index: 1000;
            display: none;
        }

        .context-menu-item {
            padding: 0.5rem 1rem;
            cursor: pointer;
            font-family: 'Unbounded', sans-serif;
            font-size: 0.85rem;
            color: #26201F;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .context-menu-item:hover {
            background: #f5f5f5;
        }

        .context-menu-item.delete {
            color: #F53151;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="nav-placeholder"></div>
        <main class="content">
            <div class="search-row">
                <div class="search-box" style="flex: 0.4;">
                    <input type="text" placeholder="Campaign brief/goal..." class="brand-input" id="campaignBrief" data-translation-key="storyboard-campaign-brief">
                </div>
                <div class="search-box" style="flex: 0.6;">
                    <input type="text" placeholder="Describe your video concept..." class="brand-input" id="videoConcept" data-translation-key="storyboard-concept-placeholder">
                </div>
            </div>
            <div class="search-row">
                <select class="integration-select placeholder" id="integrationType" style="width: 200px; flex: 0.3;">
                    <option value="" disabled selected data-translation-key="storyboard-integration-placeholder">Integration</option>
                    <option value="brand_mention" data-translation-key="integration-mention">Mention</option>
                    <option value="mid_video" data-translation-key="integration-adbreak">Ad Break</option>
                    <option value="full_integration" data-translation-key="integration-full">Full Integration</option>
                </select>
                <div class="creator-select-box" style="flex: 0.7;">
                    <input type="text" placeholder="Select a creator..." class="creator-input" id="creatorInput" readonly data-translation-key="storyboard-creator-placeholder">
                    <img src="/icons/drop_down.svg" alt="Dropdown" class="creator-dropdown-arrow" id="creatorDropdownArrow">
                    <div class="creator-dropdown-menu" id="creatorDropdown"></div>
                </div>
                <button class="get-dna-btn" onclick="generateStoryboard()" style="flex-shrink: 0;" data-translation-key="storyboard-generate-button">GENERATE STORYBOARD</button>
            </div>
            
            <div class="loading-container">
                <div class="loading-spinner"></div>
                <div class="loading-text">generating...</div>
            </div>
            
            <div class="storyboard-results-container">
                <div class="storyboard-grid" id="storyboardGridRow1">
                    <!-- First 4 frames will be added here -->
                </div>
                <div class="storyboard-grid-row2" id="storyboardGridRow2">
                    <!-- Last 3 frames will be added here -->
                </div>
                <button class="review-storyboard-btn" onclick="reviewStoryboard()" data-translation-key="storyboard-review-button">
                    ${translations['storyboard-review-button'][getClientLanguage()]}
                </button>
            </div>
        </main>
    </div>

    <!-- Context Menu -->
    <div class="context-menu" id="frameContextMenu">
        <div class="context-menu-item delete" onclick="deleteFrame()">
            <svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20" fill="currentColor">
                <path d="M280-120q-33 0-56.5-23.5T200-200v-520h-40v-80h200v-40h240v40h200v80h-40v520q0 33-23.5 56.5T680-120H280Zm400-600H280v520h400v-520ZM360-280h80v-360h-80v360Zm160 0h80v-360h-80v360ZM280-720v520-520Z"/>
            </svg>
            Delete Scene
        </div>
    </div>

    <script>
        let selectedCreatorDNA = null;
        let currentStoryboard = [];
        const STORYBOARD_IMAGE_BATCH_SIZE = 4; // Adjust this number to control how many images are generated at once

        document.addEventListener('DOMContentLoaded', async () => {
            await translateUI();
            

            // Dropdown handling
            const dropdownArrow = document.getElementById('creatorDropdownArrow');
            const dropdownMenu = document.getElementById('creatorDropdown');

            dropdownArrow.addEventListener('click', async (e) => {
                e.stopPropagation();
                dropdownMenu.classList.toggle('active');
                if (dropdownMenu.classList.contains('active')) {
                    await loadCreatorOptions();
                }
            });

            document.addEventListener('click', (e) => {
                if (!dropdownMenu.contains(e.target) && !dropdownArrow.contains(e.target)) {
                    dropdownMenu.classList.remove('active');
                }
            });

            // Handle placeholder state for integration select
            const integrationSelect = document.getElementById('integrationType');
            
            integrationSelect.addEventListener('change', function() {
                if (this.value) {
                    this.classList.remove('placeholder');
                } else {
                    this.classList.add('placeholder');
                }
            });

            // Check for URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const concept = urlParams.get('concept');
            const integration = urlParams.get('integration');
            const creator = urlParams.get('creator');

            if (concept && integration && creator) {
                // Set the concept
                document.getElementById('videoConcept').value = decodeURIComponent(concept);

                // Set the campaign brief if it exists
                const campaignBrief = urlParams.get('campaignBrief');
                if (campaignBrief) {
                    document.getElementById('campaignBrief').value = decodeURIComponent(campaignBrief);
                }

                // Set the integration type
                document.getElementById('integrationType').value = integration;
                document.getElementById('integrationType').classList.remove('placeholder');

                // First, set creator input value
                document.getElementById('creatorInput').value = decodeURIComponent(creator);

                // Then load creator options and set selected creator
                loadCreatorOptions().then(async () => {
                    // Get creator data
                    const response = await fetch(`${window.API_BASE_URL}/api/v1/creatorDNA/getCreatorDNAs`);
                    const creators = await response.json();

                    // Set the selected creator DNA
                    selectedCreatorDNA = creators[decodeURIComponent(creator)];

                    // Generate the storyboard after a short delay
                    setTimeout(() => {
                        generateStoryboard();
                    }, 500);
                });
            }
        });

        async function loadCreatorOptions() {
            try {
                const response = await fetch(`${window.API_BASE_URL}/api/v1/creatorDNA/getCreatorDNAs`);
                const creators = await response.json();
                const dropdownMenu = document.getElementById('creatorDropdown');
                dropdownMenu.innerHTML = '';

                const sortedCreatorNames = Object.keys(creators).sort((a, b) =>
                    a.toLowerCase().localeCompare(b.toLowerCase())
                );

                sortedCreatorNames.forEach(creatorName => {
                    const item = document.createElement('div');
                    item.className = 'creator-dropdown-item';
                    item.textContent = creatorName;
                    item.addEventListener('click', () => {
                        selectedCreatorDNA = creators[creatorName];
                        document.getElementById('creatorInput').value = creatorName;
                        dropdownMenu.classList.remove('active');
                    });
                    dropdownMenu.appendChild(item);
                });
            } catch (error) {
                console.error('Error loading creators:', error);
            }
        }

        async function generateStoryboard() {
            const campaignBrief = document.getElementById('campaignBrief').value.trim();
            const videoConcept = document.getElementById('videoConcept').value.trim();
            const integrationType = document.getElementById('integrationType').value;
            const loadingContainer = document.querySelector('.loading-container');
            const storyboardContainer = document.querySelector('.storyboard-results-container');
            
            if (!videoConcept) {
                alert('Please enter a video concept');
                return;
            }

            if (!integrationType) {
                alert('Please select an integration type');
                return;
            }

            if (!selectedCreatorDNA) {
                alert('Please select a creator');
                return;
            }

            const currentBrandDNA = getClientDNA();
            if (!currentBrandDNA) {
                alert('Please select a brand DNA');
                return;
            }

            // Create an integration type description map
            const integrationDescriptions = {
                brand_mention: "A short (15-30 second) acknowledgement of the brand within the video, usually involving a brief description and call to action.",
                mid_video: "A distinct 30-60 second (or longer) promotional segment in the middle of the video, where the creator directly promotes the brand and its products.",
                full_integration: "The brand's product or service is seamlessly woven into the video's core content, acting as a central element of the story, tutorial, or challenge."
            };

            try {
                loadingContainer.style.display = 'flex';
                storyboardContainer.innerHTML = `
                    <div class="storyboard-grid" id="storyboardGridRow1">
                        <!-- First 4 frames will be added here -->
                    </div>
                    <div class="storyboard-grid-row2" id="storyboardGridRow2">
                        <!-- Last 3 frames will be added here -->
                    </div>
                    <button class="review-storyboard-btn" onclick="reviewStoryboard()" data-translation-key="storyboard-review-button">
                        ${translations['storyboard-review-button'][getClientLanguage()]}
                    </button>
                `;
                
                const gridRow1 = document.getElementById('storyboardGridRow1');
                const gridRow2 = document.getElementById('storyboardGridRow2');
                
                gridRow1.innerHTML = '';
                gridRow2.innerHTML = '';

                const clientLanguage = getClientLanguage();
                console.log('Client language detected:', clientLanguage);
                
                const requestBody = {
                    campaignBrief: campaignBrief + " (This describes the brand's marketing objectives and goals for this campaign)",
                    videoConcept: videoConcept + " (This describes the actual content and storyline of the video)",
                    brandDNA: currentBrandDNA,
                    creatorDNA: selectedCreatorDNA,
                    integrationType: {
                        type: integrationType,
                        description: integrationDescriptions[integrationType]
                    },
                    language: clientLanguage,
                    version: 'v2' // Specify that we want the v2 version with 7 scenes
                };
                
                console.log('Sending storyboard request with language:', clientLanguage);

                const response = await fetch(`${window.API_BASE_URL}/generateStoryboard`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                const cleanJSON = data.replace(/```json\n|\n```/g, '').trim();
                const storyboard = JSON.parse(cleanJSON).storyboard;
                
                // Store the current storyboard data
                currentStoryboard = storyboard;

                // Hide loading container and show cards immediately with placeholder images
                loadingContainer.style.display = 'none';

                // Create cards with text content first
                storyboard.forEach((act, index) => {
                    const card = document.createElement('div');
                    card.className = 'storyboard-card';
                    card.style.borderColor = currentBrandDNA.brandColors[0];
                    card.dataset.index = index;

                    // Create content section
                    const cardContent = document.createElement('div');
                    cardContent.className = 'card-content';

                    // Add placeholder image
                    const imageWrapper = document.createElement('div');
                    imageWrapper.className = 'image-wrapper';
                    imageWrapper.innerHTML = `
                        <div class="storyboard-image-loading">
                            <div class="regenerating-spinner"></div>
                        </div>
                    `;
                    cardContent.appendChild(imageWrapper);

                    // Create scene number
                    const sceneNumber = document.createElement('div');
                    sceneNumber.className = 'scene-number';
                    const sceneKey = `scene-${index + 1}`;
                    sceneNumber.setAttribute('data-translation-key', sceneKey);
                    sceneNumber.textContent = `Scene ${index + 1}`;

                    const title = document.createElement('h2');
                    title.className = 'brand-card-title';
                    title.textContent = act.act_title;

                    const body = document.createElement('div');
                    body.className = 'brand-card-body';
                    body.textContent = act.act_description;

                    // Create prompt reveal section
                    const promptSection = document.createElement('div');
                    promptSection.className = 'prompt-section';

                    const promptButton = document.createElement('button');
                    promptButton.className = 'prompt-button';
                    promptButton.innerHTML = `
                        <span data-translation-key="storyboard-show-prompt">Show Prompt</span>
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" 
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" 
                        class="chevron-icon">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                    `;

                    const promptContent = document.createElement('div');
                    promptContent.className = 'prompt-content';
                    promptContent.textContent = act.image_prompt;

                    promptButton.addEventListener('click', () => {
                        const isExpanded = promptContent.style.display !== 'none';
                        promptContent.style.display = isExpanded ? 'none' : 'block';
                        promptButton.classList.toggle('expanded');
                    });

                    promptSection.appendChild(promptButton);
                    promptSection.appendChild(promptContent);

                    // Add elements to the card content
                    cardContent.appendChild(sceneNumber);
                    cardContent.appendChild(title);
                    cardContent.appendChild(body);
                    cardContent.appendChild(promptSection);
                    
                    // Add the card content to the card
                    card.appendChild(cardContent);
                    
                    // Create card footer
                    const cardFooter = document.createElement('div');
                    cardFooter.className = 'card-footer';
                    
                    // Add regenerate button to the footer
                    const regenerateBtn = document.createElement('button');
                    regenerateBtn.className = 'regenerate-btn';
                    regenerateBtn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="#666" class="regenerate-icon">
                            <path d="M482-160q-134 0-228-93t-94-227v-7l-64 64-56-56 160-160 160 160-56 56-64-64v7q0 100 70.5 170T482-240q26 0 51-6t49-18l60 60q-38 22-78 33t-82 11Zm278-161L600-481l56-56 64 64v-7q0-100-70.5-170T478-720q-26 0-51 6t-49 18l-60-60q38-22 78-33t82-11q134 0 228 93t94 227v7l64-64 56 56-160 160Z"/>
                        </svg>
                        <span data-translation-key="storyboard-regenerate-frame">Regenerate Scene</span>
                    `;
                    regenerateBtn.addEventListener('click', () => toggleFeedbackArea(index));
                    cardFooter.appendChild(regenerateBtn);
                    
                    // Add the footer to the card
                    card.appendChild(cardFooter);
                    
                    // Add feedback container
                    const feedbackContainer = document.createElement('div');
                    feedbackContainer.className = 'feedback-container';
                    feedbackContainer.id = `feedback-container-${index}`;
                    
                    const feedbackTextarea = document.createElement('textarea');
                    feedbackTextarea.className = 'feedback-textarea';
                    feedbackTextarea.placeholder = 'Describe how you want to change this frame...';
                    feedbackTextarea.id = `feedback-textarea-${index}`;
                    
                    const feedbackActions = document.createElement('div');
                    feedbackActions.className = 'feedback-actions';
                    
                    const submitBtn = document.createElement('button');
                    submitBtn.className = 'submit-feedback-btn';
                    submitBtn.setAttribute('data-translation-key', 'storyboard-submit-button');
                    submitBtn.textContent = 'Submit';
                    submitBtn.addEventListener('click', () => regenerateFrame(index));
                    
                    const cancelBtn = document.createElement('button');
                    cancelBtn.className = 'cancel-feedback-btn';
                    cancelBtn.setAttribute('data-translation-key', 'storyboard-cancel-button');
                    cancelBtn.textContent = 'Cancel';
                    cancelBtn.addEventListener('click', () => toggleFeedbackArea(index));
                    
                    feedbackActions.appendChild(submitBtn);
                    feedbackActions.appendChild(cancelBtn);
                    
                    feedbackContainer.appendChild(feedbackTextarea);
                    feedbackContainer.appendChild(feedbackActions);
                    
                    card.appendChild(feedbackContainer);
                    
                    // Add regenerating indicator
                    const regeneratingIndicator = document.createElement('div');
                    regeneratingIndicator.className = 'regenerating-indicator';
                    regeneratingIndicator.id = `regenerating-indicator-${index}`;
                    
                    const spinner = document.createElement('div');
                    spinner.className = 'regenerating-spinner';
                    
                    const text = document.createElement('div');
                    text.textContent = 'Regenerating frame...';
                    
                    regeneratingIndicator.appendChild(spinner);
                    regeneratingIndicator.appendChild(text);
                    
                    card.appendChild(regeneratingIndicator);
                    
                    // Add to appropriate row
                    if (index < 4) {
                        gridRow1.appendChild(card);
                    } else {
                        gridRow2.appendChild(card);
                    }
                });

                // Generate images in batches
                const generateImagesInBatches = async (allPrompts) => {
                    const results = [];
                    const totalImages = allPrompts.length;
                    
                    // Generate images in batches of STORYBOARD_IMAGE_BATCH_SIZE
                    for (let i = 0; i < totalImages; i += STORYBOARD_IMAGE_BATCH_SIZE) {
                        try {
                            const batchPrompts = allPrompts.slice(i, i + STORYBOARD_IMAGE_BATCH_SIZE);
                            
                            // Add retry logic for the API call
                            let retryCount = 0;
                            const maxRetries = 3;
                            let lastError;
                            
                            while (retryCount < maxRetries) {
                                try {
                                    const response = await fetch(`${window.API_BASE_URL}/generateStoryboardImages`, {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json'
                                        },
                                        body: JSON.stringify({ 
                                            imagePrompts: batchPrompts,
                                            language: getClientLanguage()
                                        })
                                    });
                                    
                                    if (!response.ok) {
                                        throw new Error(`HTTP error! status: ${response.status}`);
                                    }
                                    
                                    const data = await response.json();
                                    results.push(...data.images);
                                    
                                    // Success - update UI and break retry loop
                                    data.images.forEach((imageBase64, batchIndex) => {
                                        const cardIndex = i + batchIndex;
                                        const card = document.querySelector(`.storyboard-card[data-index="${cardIndex}"]`);
                                        if (!card) return;
                                        
                                        const imageWrapper = card.querySelector('.image-wrapper');
                                        if (!imageWrapper) return;
                                        
                                        imageWrapper.innerHTML = ''; // Clear loading spinner
                                        
                                        const img = document.createElement('img');
                                        img.src = `data:image/png;base64,${imageBase64}`;
                                        img.className = 'storyboard-image';
                                        
                                        // Create download button
                                        const downloadButton = document.createElement('button');
                                        downloadButton.className = 'download-button';
                                        downloadButton.innerHTML = `
                                            <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="white">
                                                <path d="M480-320 280-520l56-58 104 104v-326h80v326l104-104 56 58-200 200ZM240-160q-33 0-56.5-23.5T160-240v-120h80v120h480v-120h80v120q0 33-23.5 56.5T720-160H240Z"/>
                                            </svg>
                                        `;
                                        
                                        downloadButton.addEventListener('click', (e) => {
                                            e.stopPropagation();
                                            const link = document.createElement('a');
                                            link.href = img.src;
                                            link.download = `storyboard-scene-${cardIndex + 1}.png`;
                                            document.body.appendChild(link);
                                            link.click();
                                            document.body.removeChild(link);
                                        });
                                        
                                        imageWrapper.appendChild(img);
                                        imageWrapper.appendChild(downloadButton);
                                    });
                                    
                                    break; // Exit retry loop on success
                                } catch (error) {
                                    lastError = error;
                                    retryCount++;
                                    
                                    if (retryCount < maxRetries) {
                                        // Wait with exponential backoff before retrying
                                        await new Promise(resolve => setTimeout(resolve, Math.pow(2, retryCount) * 1000));
                                        continue;
                                    }
                                    throw error; // Throw the last error if all retries failed
                                }
                            }
                        } catch (error) {
                            console.error(`Error generating batch starting at index ${i}:`, error);
                        }
                    }
                    
                    return results;
                };

                // Generate images in batches
                const imagePrompts = storyboard.map(act => act.image_prompt);
                generateImagesInBatches(imagePrompts).catch(error => {
                    console.error('Error in batch generation:', error);
                });

                // Set up event listeners and create add scene buttons
                setupCardEventListeners();
                setTimeout(createAddSceneButtons, 500);

                // Show the review button
                const reviewButton = document.querySelector('.review-storyboard-btn');
                if (reviewButton) {
                    reviewButton.style.display = 'flex';
                }

            } catch (error) {
                console.error('Error:', error);
                loadingContainer.style.display = 'none';
                alert(`Error: ${error.message}`);
            }
        }

        // Function to toggle the feedback area
        function toggleFeedbackArea(index) {
            const feedbackContainer = document.getElementById(`feedback-container-${index}`);
            if (feedbackContainer.style.display === 'block') {
                feedbackContainer.style.display = 'none';
            } else {
                feedbackContainer.style.display = 'block';
            }
        }
        
        // Function to regenerate a single frame
        async function regenerateFrame(index) {
            const feedbackText = document.getElementById(`feedback-textarea-${index}`).value.trim();
            if (!feedbackText) {
                alert('Please provide feedback on how to change the frame.');
                return;
            }
            
            const regeneratingIndicator = document.getElementById(`regenerating-indicator-${index}`);
            regeneratingIndicator.style.display = 'flex';
            
            try {
                const campaignBrief = document.getElementById('campaignBrief').value.trim();
                const videoConcept = document.getElementById('videoConcept').value.trim();
                const integrationType = document.getElementById('integrationType').value;
                const currentBrandDNA = getClientDNA();
                
                // Create an integration type description map
                const integrationDescriptions = {
                    brand_mention: "A short (15-30 second) acknowledgement of the brand within the video, usually involving a brief description and call to action.",
                    mid_video: "A distinct 30-60 second (or longer) promotional segment in the middle of the video, where the creator directly promotes the brand and its products.",
                    full_integration: "The brand's product or service is seamlessly woven into the video's core content, acting as a central element of the story, tutorial, or challenge."
                };
                
                const requestBody = {
                    campaignBrief: campaignBrief + " (This describes the brand's marketing objectives and goals for this campaign)",
                    videoConcept: videoConcept + " (This describes the actual content and storyline of the video)",
                    brandDNA: currentBrandDNA,
                    creatorDNA: selectedCreatorDNA,
                    integrationType: {
                        type: integrationType,
                        description: integrationDescriptions[integrationType]
                    },
                    language: getClientLanguage(),
                    storyboard: currentStoryboard,
                    frameIndex: index,
                    feedback: feedbackText
                };
                
                const response = await fetch(`${window.API_BASE_URL}/regenerateStoryboardFrame`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Update the storyboard data
                currentStoryboard[index] = data.frame;
                
                // Generate the new image
                const imageResponse = await fetch(`${window.API_BASE_URL}/generateStoryboardImages`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        imagePrompts: [data.frame.image_prompt],
                        language: getClientLanguage()
                    })
                });
                
                if (!imageResponse.ok) {
                    throw new Error(`HTTP error! status: ${imageResponse.status}`);
                }
                
                const imageData = await imageResponse.json();
                
                // Update the card with new content
                const card = document.querySelector(`.storyboard-card[data-index="${index}"]`);
                
                // Update image
                const img = card.querySelector('.storyboard-image');
                if (img && imageData.images[0]) {
                    img.src = `data:image/png;base64,${imageData.images[0]}`;
                }
                
                // Update title and description
                const title = card.querySelector('.brand-card-title');
                const body = card.querySelector('.brand-card-body');
                
                if (title) title.textContent = data.frame.act_title;
                if (body) body.textContent = data.frame.act_description;
                
                // Hide the feedback area
                document.getElementById(`feedback-container-${index}`).style.display = 'none';
                
            } catch (error) {
                console.error('Error regenerating frame:', error);
                alert(`Error: ${error.message}`);
            } finally {
                regeneratingIndicator.style.display = 'none';
            }
        }

        // Function to create add scene buttons
        function createAddSceneButtons() {
            // Remove any existing add buttons
            document.querySelectorAll('.add-scene-button').forEach(btn => btn.remove());
            
            const storyboardCards = document.querySelectorAll('.storyboard-card');
            if (storyboardCards.length === 0) return;
            
            const gridContainer = document.querySelector('.storyboard-results-container');
            const gridRect = gridContainer.getBoundingClientRect();
            
            // Remove any existing popup before creating a new one
            const existingPopup = document.querySelector('.add-scene-popup');
            if (existingPopup) {
                existingPopup.remove();
            }
            
            // Create popup for adding new scenes
            const popup = document.createElement('div');
            popup.className = 'add-scene-popup';
            popup.id = 'addScenePopup';
            popup.innerHTML = `
                <div class="popup-overlay"></div>
                <div class="popup-content">
                    <h3 data-translation-key="storyboard-add-scene">Add New Scene</h3>
                    <textarea placeholder="Describe the new scene you'd like to add..." id="new-scene-description"></textarea>
                    <div class="popup-actions">
                        <button class="add-scene-confirm-btn" data-translation-key="storyboard-add-scene-button">Add Scene</button>
                        <button class="add-scene-cancel-btn" data-translation-key="storyboard-cancel-button">Cancel</button>
                    </div>
                </div>
            `;
            document.body.appendChild(popup);
            
            // Hide popup initially
            popup.style.display = 'none';
            
            // Add event listeners to popup buttons
            const confirmBtn = popup.querySelector('.add-scene-confirm-btn');
            const cancelBtn = popup.querySelector('.add-scene-cancel-btn');
            const overlay = popup.querySelector('.popup-overlay');
            
            cancelBtn.addEventListener('click', () => {
                popup.style.display = 'none';
            });
            
            overlay.addEventListener('click', () => {
                popup.style.display = 'none';
            });
            
            // Add event listener to confirm button with direct access to the textarea
            confirmBtn.addEventListener('click', () => {
                const description = document.getElementById('new-scene-description').value.trim();
                
                if (!description) {
                    alert('Please enter a description for the new scene.');
                    return;
                }
                
                const position = popup.dataset.position;
                const index = parseInt(popup.dataset.index);
                
                // Add the placeholder card
                addPlaceholderCard(position, index, description);
                
                // Hide popup
                popup.style.display = 'none';
            });
            
            // Create a button before the first card
            const firstCard = storyboardCards[0];
            const firstCardRect = firstCard.getBoundingClientRect();
            
            const beforeButton = document.createElement('button');
            beforeButton.className = 'add-scene-button';
            beforeButton.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24">
                    <path d="M440-440H200v-80h240v-240h80v240h240v80H520v240h-80v-240Z" fill="white"/>
                </svg>
            `;
            
            // Position the button to the left of the first card
            const leftPosition = firstCardRect.left - gridRect.left - 30; // 30px to the left
            const midpointY = (firstCardRect.top + firstCardRect.bottom) / 2 - gridRect.top;
            
            beforeButton.style.left = `${leftPosition}px`;
            beforeButton.style.top = `${midpointY}px`;
            
            // Add data attribute to track position
            beforeButton.dataset.position = 'before';
            beforeButton.dataset.index = '0';
            
            gridContainer.appendChild(beforeButton);
            
            // Create buttons between cards in the first row
            for (let i = 0; i < storyboardCards.length - 1; i++) {
                const card1 = storyboardCards[i];
                const card2 = storyboardCards[i + 1];
                
                // Skip if cards are not in the same row
                if (i === 3) continue; // Skip between rows
                
                const rect1 = card1.getBoundingClientRect();
                const rect2 = card2.getBoundingClientRect();
                
                const betweenButton = document.createElement('button');
                betweenButton.className = 'add-scene-button';
                betweenButton.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24">
                        <path d="M440-440H200v-80h240v-240h80v240h240v80H520v240h-80v-240Z" fill="white"/>
                    </svg>
                `;
                
                // Position the button between the cards
                const midpointX = (rect1.right + rect2.left) / 2 - gridRect.left;
                const midpointY = (rect1.top + rect1.bottom) / 2 - gridRect.top;
                
                betweenButton.style.left = `${midpointX}px`;
                betweenButton.style.top = `${midpointY}px`;
                
                // Add data attribute to track position
                betweenButton.dataset.position = 'between';
                betweenButton.dataset.index = `${i + 1}`;
                
                gridContainer.appendChild(betweenButton);
            }
            
            // Create buttons between cards in the second row
            const gridContainer2 = document.querySelector('.storyboard-results-container');
            const gridRect2 = gridContainer2.getBoundingClientRect();
            
            for (let i = 4; i < storyboardCards.length - 1; i++) {
                const card1 = storyboardCards[i];
                const card2 = storyboardCards[i + 1];
                
                const rect1 = card1.getBoundingClientRect();
                const rect2 = card2.getBoundingClientRect();
                
                const betweenButton = document.createElement('button');
                betweenButton.className = 'add-scene-button';
                betweenButton.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24">
                        <path d="M440-440H200v-80h240v-240h80v240h240v80H520v240h-80v-240Z" fill="white"/>
                    </svg>
                `;
                
                // Position the button between the cards
                const midpointX = (rect1.right + rect2.left) / 2 - gridRect2.left;
                const midpointY = (rect1.top + rect1.bottom) / 2 - gridRect2.top;
                
                betweenButton.style.left = `${midpointX}px`;
                betweenButton.style.top = `${midpointY}px`;
                
                // Add data attribute to track position
                betweenButton.dataset.position = 'between';
                betweenButton.dataset.index = `${i + 1}`;
                
                gridContainer2.appendChild(betweenButton);
            }
            
            // Create a button after the last card
            const lastCard = storyboardCards[storyboardCards.length - 1];
            const lastCardRect = lastCard.getBoundingClientRect();
            
            const afterButton = document.createElement('button');
            afterButton.className = 'add-scene-button';
            afterButton.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24">
                    <path d="M440-440H200v-80h240v-240h80v240h240v80H520v240h-80v-240Z" fill="white"/>
                </svg>
            `;
            
            // Position the button to the right of the last card
            const rightPosition = lastCardRect.right - gridRect.left + 30; // 30px to the right
            const lastMidpointY = (lastCardRect.top + lastCardRect.bottom) / 2 - gridRect.top;
            
            afterButton.style.left = `${rightPosition}px`;
            afterButton.style.top = `${lastMidpointY}px`;
            
            // Add data attribute to track position
            afterButton.dataset.position = 'after';
            afterButton.dataset.index = `${storyboardCards.length}`;
            
            gridContainer.appendChild(afterButton);
            
            // Add event listeners to all add buttons
            document.querySelectorAll('.add-scene-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    // Show popup
                    popup.style.display = 'block';
                    
                    // Store the button's position and index in the popup
                    popup.dataset.position = button.dataset.position;
                    popup.dataset.index = button.dataset.index;
                    
                    // Clear any previous input
                    document.getElementById('new-scene-description').value = '';
                });
            });
        }

        // Function to add a placeholder card at the specified position
        function addPlaceholderCard(position, index, description) {
            console.log('=== Starting Add Placeholder Card ===');
            console.log('Position:', position);
            console.log('Index:', index);
            
            const currentBrandDNA = getClientDNA();
            const placeholderCard = createPlaceholderCard(description, currentBrandDNA);
            
            // Insert the new frame data at the correct position in currentStoryboard
            const newFrame = {
                act_title: "New Scene",
                act_description: description,
                image_prompt: "Generating...",
                image_url: ""
            };
            
            // Get the grid rows
            const gridRow1 = document.getElementById('storyboardGridRow1');
            const gridRow2 = document.getElementById('storyboardGridRow2');
            
            console.log('Current storyboard length before adding:', currentStoryboard.length);
            
            // Update the storyboard data
            if (position === 'before') {
                currentStoryboard.unshift(newFrame);
            } else if (position === 'between') {
                currentStoryboard.splice(index, 0, newFrame);
            } else if (position === 'after') {
                currentStoryboard.push(newFrame);
            }
            
            console.log('Current storyboard length after adding:', currentStoryboard.length);
            
            // Get all existing cards and add the new one
            const allCards = [...document.querySelectorAll('.storyboard-card')];
            
            // Remove all cards from DOM first
            allCards.forEach(card => card.remove());
            
            // Insert the new card at the correct position
            allCards.splice(index, 0, placeholderCard);
            
            // Redistribute all cards
            allCards.forEach((card, idx) => {
                card.dataset.index = idx;
                if (idx < 4) {
                    gridRow1.appendChild(card);
                } else {
                    gridRow2.appendChild(card);
                }
            });
            
            // Update scene numbers
            updateSceneNumbers();
            
            // Add event listeners to the new card
            setupCardEventListeners();
            
            // Recreate add scene buttons
            createAddSceneButtons();
            
            // Generate the new scene content
            generateNewSceneContent(index, description, position);
            
            console.log('=== Add Placeholder Card Complete ===');
        }

        // Function to set up event listeners for all cards
        function setupCardEventListeners() {
            const cards = document.querySelectorAll('.storyboard-card');
            
            cards.forEach((card, index) => {
                // Set the card's index
                card.dataset.index = index;
                
                // Set up regenerate button
                const regenerateBtn = card.querySelector('.regenerate-btn');
                if (regenerateBtn) {
                    // Remove any existing event listeners
                    const newBtn = regenerateBtn.cloneNode(true);
                    regenerateBtn.parentNode.replaceChild(newBtn, regenerateBtn);
                    
                    // Add new event listener
                    newBtn.addEventListener('click', () => toggleFeedbackArea(index));
                }
                
                // Set up feedback container
                const feedbackContainer = card.querySelector('.feedback-container');
                if (feedbackContainer) {
                    feedbackContainer.id = `feedback-container-${index}`;
                    
                    // Set up textarea
                    const textarea = feedbackContainer.querySelector('.feedback-textarea');
                    if (textarea) {
                        textarea.id = `feedback-textarea-${index}`;
                    }
                    
                    // Set up submit button
                    const submitBtn = feedbackContainer.querySelector('.submit-feedback-btn');
                    if (submitBtn) {
                        // Remove any existing event listeners
                        const newSubmitBtn = submitBtn.cloneNode(true);
                        submitBtn.parentNode.replaceChild(newSubmitBtn, submitBtn);
                        
                        // Add new event listener
                        newSubmitBtn.addEventListener('click', () => regenerateFrame(index));
                    }
                    
                    // Set up cancel button
                    const cancelBtn = feedbackContainer.querySelector('.cancel-feedback-btn');
                    if (cancelBtn) {
                        // Remove any existing event listeners
                        const newCancelBtn = cancelBtn.cloneNode(true);
                        cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
                        
                        // Add new event listener
                        newCancelBtn.addEventListener('click', () => toggleFeedbackArea(index));
                    }
                }
                
                // Set up regenerating indicator
                const indicator = card.querySelector('.regenerating-indicator');
                if (indicator) {
                    indicator.id = `regenerating-indicator-${index}`;
                }
            });
        }

        // Function to create a placeholder card
        function createPlaceholderCard(description, brandDNA) {
            const card = document.createElement('div');
            card.className = 'storyboard-card';
            card.style.borderColor = brandDNA ? brandDNA.brandColors[0] : '#ccc';
            
            // Create content section
            const cardContent = document.createElement('div');
            cardContent.className = 'card-content';
            
            // Add placeholder image
            const imageWrapper = document.createElement('div');
            imageWrapper.className = 'image-wrapper';
            
            const placeholderImage = document.createElement('div');
            placeholderImage.className = 'storyboard-image-loading';
            placeholderImage.innerHTML = `
                <div style="text-align: center;">
                </div>
            `;
            
            imageWrapper.appendChild(placeholderImage);
            cardContent.appendChild(imageWrapper);
            
            // Create scene number (will be updated later)
            const sceneNumber = document.createElement('div');
            sceneNumber.className = 'scene-number';
            sceneNumber.textContent = 'New Scene';
            
            const title = document.createElement('h2');
            title.className = 'brand-card-title';
            title.textContent = 'New Scene';
            
            const body = document.createElement('div');
            body.className = 'brand-card-body';
            body.textContent = description;
            
            // Add elements to the card content
            cardContent.appendChild(sceneNumber);
            cardContent.appendChild(title);
            cardContent.appendChild(body);
            
            // Add the card content to the card
            card.appendChild(cardContent);
            
            // Create card footer
            const cardFooter = document.createElement('div');
            cardFooter.className = 'card-footer';
            
            // Add regenerate button to the footer
            const regenerateBtn = document.createElement('button');
            regenerateBtn.className = 'regenerate-btn';
            regenerateBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="#666" class="regenerate-icon">
                    <path d="M482-160q-134 0-228-93t-94-227v-7l-64 64-56-56 160-160 160 160-56 56-64-64v7q0 100 70.5 170T482-240q26 0 51-6t49-18l60 60q-38 22-78 33t-82 11Zm278-161L600-481l56-56 64 64v-7q0-100-70.5-170T478-720q-26 0-51 6t-49 18l-60-60q38-22 78-33t82-11q134 0 228 93t94 227v7l64-64 56 56-160 160Z"/>
                </svg>
                <span data-translation-key="storyboard-regenerate-frame">Regenerate Scene</span>
            `;
            
            cardFooter.appendChild(regenerateBtn);
            card.appendChild(cardFooter);
            
            // Add feedback container
            const feedbackContainer = document.createElement('div');
            feedbackContainer.className = 'feedback-container';
            
            const feedbackTextarea = document.createElement('textarea');
            feedbackTextarea.className = 'feedback-textarea';
            feedbackTextarea.placeholder = 'Describe how you want to change this frame...';
            
            const feedbackActions = document.createElement('div');
            feedbackActions.className = 'feedback-actions';
            
            const submitBtn = document.createElement('button');
            submitBtn.className = 'submit-feedback-btn';
            submitBtn.setAttribute('data-translation-key', 'storyboard-submit-button');
            submitBtn.textContent = 'Submit';
            submitBtn.addEventListener('click', () => regenerateFrame(index));
            
            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'cancel-feedback-btn';
            cancelBtn.setAttribute('data-translation-key', 'storyboard-cancel-button');
            cancelBtn.textContent = 'Cancel';
            cancelBtn.addEventListener('click', () => toggleFeedbackArea(index));
            
            feedbackActions.appendChild(submitBtn);
            feedbackActions.appendChild(cancelBtn);
            
            feedbackContainer.appendChild(feedbackTextarea);
            feedbackContainer.appendChild(feedbackActions);
            
            card.appendChild(feedbackContainer);
            
            // Add regenerating indicator
            const regeneratingIndicator = document.createElement('div');
            regeneratingIndicator.className = 'regenerating-indicator';
            regeneratingIndicator.style.display = 'flex'; // Show the indicator immediately
            
            const spinner = document.createElement('div');
            spinner.className = 'regenerating-spinner';
            
            const text = document.createElement('div');
            text.textContent = 'Generating scene...';
            
            regeneratingIndicator.appendChild(spinner);
            regeneratingIndicator.appendChild(text);
            
            card.appendChild(regeneratingIndicator);
            
            return card;
        }

        // Function to generate content for a new scene
        async function generateNewSceneContent(index, description, position) {
            // Get the card element
            const card = document.querySelector(`.storyboard-card[data-index="${index}"]`);
            if (!card) return;
            
            // Show the regenerating indicator
            const regeneratingIndicator = card.querySelector('.regenerating-indicator');
            if (regeneratingIndicator) {
                regeneratingIndicator.style.display = 'flex';
            }
            
            try {
                const campaignBrief = document.getElementById('campaignBrief').value.trim();
                const videoConcept = document.getElementById('videoConcept').value.trim();
                const integrationType = document.getElementById('integrationType').value;
                const currentBrandDNA = getClientDNA();
                
                // Create an integration type description map
                const integrationDescriptions = {
                    brand_mention: "A short (15-30 second) acknowledgement of the brand within the video, usually involving a brief description and call to action.",
                    mid_video: "A distinct 30-60 second (or longer) promotional segment in the middle of the video, where the creator directly promotes the brand and its products.",
                    full_integration: "The brand's product or service is seamlessly woven into the video's core content, acting as a central element of the story, tutorial, or challenge."
                };
                
                // Create context for the new scene based on position
                let contextPrompt = "";
                if (position === 'before' && currentStoryboard.length > 1) {
                    contextPrompt = `This scene should come before the current first scene: "${currentStoryboard[1].act_title}: ${currentStoryboard[1].act_description}"`;
                } else if (position === 'between') {
                    const prevIndex = Math.max(0, index - 1);
                    const nextIndex = Math.min(currentStoryboard.length - 1, index + 1);
                    
                    if (prevIndex !== index && nextIndex !== index) {
                        contextPrompt = `This scene should fit between these two scenes: 
                        Before: "${currentStoryboard[prevIndex].act_title}: ${currentStoryboard[prevIndex].act_description}"
                        After: "${currentStoryboard[nextIndex].act_title}: ${currentStoryboard[nextIndex].act_description}"`;
                    }
                } else if (position === 'after' && index > 0) {
                    contextPrompt = `This scene should come after the current last scene: "${currentStoryboard[index-1].act_title}: ${currentStoryboard[index-1].act_description}"`;
                }
                
                const requestBody = {
                    campaignBrief: campaignBrief + " (This describes the brand's marketing objectives and goals for this campaign)",
                    videoConcept: videoConcept + " (This describes the actual content and storyline of the video)",
                    brandDNA: currentBrandDNA,
                    creatorDNA: selectedCreatorDNA,
                    integrationType: {
                        type: integrationType,
                        description: integrationDescriptions[integrationType]
                    },
                    language: getClientLanguage(),
                    storyboard: currentStoryboard,
                    frameIndex: index,
                    feedback: `Generate a new scene with this description: ${description}. ${contextPrompt}`
                };
                
                const response = await fetch(`${window.API_BASE_URL}/regenerateStoryboardFrame`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Update the storyboard data
                currentStoryboard[index] = data.frame;
                
                // Generate the new image
                const imageResponse = await fetch(`${window.API_BASE_URL}/generateStoryboardImages`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        imagePrompts: [data.frame.image_prompt],
                        language: getClientLanguage()
                    })
                });
                
                if (!imageResponse.ok) {
                    throw new Error(`HTTP error! status: ${imageResponse.status}`);
                }
                
                const imageData = await imageResponse.json();
                
                // Update the card with new content
                
                // Replace the placeholder image with the real image
                const imageWrapper = card.querySelector('.image-wrapper');
                if (imageWrapper) {
                    imageWrapper.innerHTML = ''; // Clear the placeholder
                    
                    const img = document.createElement('img');
                    img.src = `data:image/png;base64,${imageData.images[0]}`;
                    img.className = 'storyboard-image';
                    
                    // Create download button
                    const downloadButton = document.createElement('button');
                    downloadButton.className = 'download-button';
                    downloadButton.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="white">
                            <path d="M480-320 280-520l56-58 104 104v-326h80v326l104-104 56 58-200 200ZM240-160q-33 0-56.5-23.5T160-240v-120h80v120h480v-120h80v120q0 33-23.5 56.5T720-160H240Z"/>
                        </svg>
                    `;
                    
                    downloadButton.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const link = document.createElement('a');
                        link.href = img.src;
                        link.download = `storyboard-scene-${index + 1}.png`;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    });
                    
                    imageWrapper.appendChild(img);
                    imageWrapper.appendChild(downloadButton);
                }
                
                // Update title and description
                const title = card.querySelector('.brand-card-title');
                const body = card.querySelector('.brand-card-body');
                
                if (title) title.textContent = data.frame.act_title;
                if (body) body.textContent = data.frame.act_description;
                
                // Add prompt reveal section if it doesn't exist
                if (!card.querySelector('.prompt-section')) {
                    const cardContent = card.querySelector('.card-content');
                    if (cardContent) {
                        const promptSection = document.createElement('div');
                        promptSection.className = 'prompt-section';
                        
                        const promptButton = document.createElement('button');
                        promptButton.className = 'prompt-button';
                        promptButton.innerHTML = `
                            <span data-translation-key="storyboard-show-prompt">Show Prompt</span>
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="chevron-icon">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                        `;
                        
                        const promptContent = document.createElement('div');
                        promptContent.className = 'prompt-content';
                        promptContent.textContent = data.frame.image_prompt;
                        
                        promptButton.addEventListener('click', () => {
                            const isExpanded = promptContent.style.display !== 'none';
                            promptContent.style.display = isExpanded ? 'none' : 'block';
                            promptButton.classList.toggle('expanded');
                        });
                        
                        promptSection.appendChild(promptButton);
                        promptSection.appendChild(promptContent);
                        
                        cardContent.appendChild(promptSection);
                    }
                }
                
            } catch (error) {
                console.error('Error generating new scene content:', error);
                alert(`Error: ${error.message}`);
            } finally {
                // Hide the regenerating indicator
                if (regeneratingIndicator) {
                    regeneratingIndicator.style.display = 'none';
                }
            }
        }

        // Function to update all scene numbers
        function updateSceneNumbers() {
            const cards = document.querySelectorAll('.storyboard-card');
            
            cards.forEach((card, index) => {
                // Update the scene number text
                const sceneNumber = card.querySelector('.scene-number');
                if (sceneNumber) {
                    sceneNumber.textContent = `Scene ${index + 1}`;
                }
            });
            
            // Set up all event listeners with the new indices
            setupCardEventListeners();
        }

        // Function to review storyboard for brand DNA violations
        async function reviewStoryboard() {
            const reviewButton = document.querySelector('.review-storyboard-btn');
            reviewButton.classList.add('loading');
            const originalText = translations['storyboard-review-button'][getClientLanguage()];
            reviewButton.innerHTML = '<div class="loading-spinner"></div>' + translations['storyboard-reviewing'][getClientLanguage()];

            try {
                const currentBrandDNA = getClientDNA();
                if (!currentBrandDNA) {
                    throw new Error('No brand DNA selected');
                }

                const campaignBrief = document.getElementById('campaignBrief').value.trim();
                const videoConcept = document.getElementById('videoConcept').value.trim();

                // Collect all scenes data
                const scenes = currentStoryboard.map((scene, index) => ({
                    sceneNumber: index + 1,
                    sceneTitle: scene.act_title,
                    sceneDescription: scene.act_description
                }));

                // Prepare request body
                const requestBody = {
                    scenes,
                    brandDNA: currentBrandDNA,
                    campaignBrief,
                    campaignGoal: videoConcept,
                    language: getClientLanguage()
                };

                const response = await fetch(`${window.API_BASE_URL}/reviewStoryboard`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                // Clear existing warnings
                clearWarningIcons();

                // Add warning icons for scenes with issues
                data.sceneWarnings.forEach(warning => {
                    if (warning.hasIssue) {
                        addWarningIcon(warning.sceneNumber - 1, warning.explanation);
                    }
                });

            } catch (error) {
                console.error('Error reviewing storyboard:', error);
                alert(`Error: ${error.message}`);
            } finally {
                reviewButton.classList.remove('loading');
                reviewButton.innerHTML = originalText;
            }
        }

        // Function to clear all warning icons
        function clearWarningIcons() {
            const warningIcons = document.querySelectorAll('.warning-icon');
            warningIcons.forEach(icon => icon.remove());
        }

        // Function to add a warning icon to a scene
        function addWarningIcon(sceneIndex, explanation) {
            const card = document.querySelector(`.storyboard-card[data-index="${sceneIndex}"]`);
            if (!card) return;

            const warningIcon = document.createElement('div');
            warningIcon.className = 'warning-icon';
            warningIcon.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24">
                    <path d="M480-280q17 0 28.5-11.5T520-320q0-17-11.5-28.5T480-360q-17 0-28.5 11.5T440-320q0 17 11.5 28.5T480-280Zm-40-160h80v-240h-80v240Zm40 360q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Zm0-80q134 0 227-93t93-227q0-134-93-227t-227-93q-134 0-227 93t-93 227q0 134 93 227t227 93Zm0-320Z"/>
                </svg>
                <div class="warning-tooltip">${explanation}</div>
            `;

            card.style.position = 'relative';
            card.insertBefore(warningIcon, card.firstChild);
        }

        // Remove warning icon when regenerating a frame
        const originalRegenerateFrame = regenerateFrame;
        regenerateFrame = async function(index) {
            // Remove warning icon if it exists
            const card = document.querySelector(`.storyboard-card[data-index="${index}"]`);
            if (card) {
                const warningIcon = card.querySelector('.warning-icon');
                if (warningIcon) {
                    warningIcon.remove();
                }
            }
            // Call the original regenerateFrame function
            await originalRegenerateFrame(index);
        };

        // Context Menu Handling
        let selectedFrameIndex = null;
        const contextMenu = document.getElementById('frameContextMenu');

        // Close context menu when clicking outside
        document.addEventListener('click', () => {
            contextMenu.style.display = 'none';
        });

        // Prevent default right click on cards and show context menu
        document.addEventListener('contextmenu', (e) => {
            const card = e.target.closest('.storyboard-card');
            if (card) {
                console.log('Context menu triggered on card');
                console.log('Card dataset index:', card.dataset.index);
                console.log('Mouse position:', { x: e.pageX, y: e.pageY });
                console.log('Card position:', card.getBoundingClientRect());
                
                e.preventDefault();
                selectedFrameIndex = parseInt(card.dataset.index);
                
                // Get viewport dimensions and scroll position
                const viewportWidth = window.innerWidth;
                const viewportHeight = window.innerHeight;
                const scrollX = window.scrollX;
                const scrollY = window.scrollY;
                
                // Get card position
                const cardRect = card.getBoundingClientRect();
                
                // Show the menu first but hidden to get its dimensions
                contextMenu.style.display = 'block';
                contextMenu.style.visibility = 'hidden';
                
                // Get menu dimensions
                const menuRect = contextMenu.getBoundingClientRect();
                
                // Calculate position relative to the viewport
                let left = e.clientX;
                let top = cardRect.top + scrollY; // Use card's top position
                
                // Adjust if menu would go outside right edge
                if (left + menuRect.width > viewportWidth) {
                    left = viewportWidth - menuRect.width - 10;
                }
                
                // Adjust if menu would go outside bottom edge
                const spaceBelow = viewportHeight - (e.clientY - scrollY);
                if (spaceBelow < menuRect.height) {
                    // If not enough space below, position above the click
                    top = e.clientY - menuRect.height;
                } else {
                    // If enough space below, position at click
                    top = e.clientY;
                }
                
                // Ensure minimum positions
                left = Math.max(10, left);
                top = Math.max(scrollY + 10, top);
                
                // Position and show menu
                contextMenu.style.left = `${left}px`;
                contextMenu.style.top = `${top}px`;
                contextMenu.style.visibility = 'visible';
                
                console.log('Context menu positioned at:', { left, top });
                console.log('Viewport dimensions:', { width: viewportWidth, height: viewportHeight });
                console.log('Scroll position:', { scrollX, scrollY });
            }
        });

        // Function to delete a frame
        function deleteFrame() {
            console.log('=== Starting Frame Deletion ===');
            console.log('Selected frame index:', selectedFrameIndex);
            
            if (selectedFrameIndex === null) {
                console.log('No frame selected for deletion');
                return;
            }

            console.log('Current storyboard length before deletion:', currentStoryboard.length);
            
            // Remove the frame from the storyboard data
            currentStoryboard.splice(selectedFrameIndex, 1);
            console.log('Current storyboard length after deletion:', currentStoryboard.length);

            // Get all rows
            const gridRow1 = document.getElementById('storyboardGridRow1');
            const gridRow2 = document.getElementById('storyboardGridRow2');
            const gridRow3 = document.getElementById('storyboardGridRow3');
            
            console.log('Found grid rows:', {
                row1: gridRow1 ? 'exists' : 'not found',
                row2: gridRow2 ? 'exists' : 'not found',
                row3: gridRow3 ? 'exists' : 'not found'
            });

            // Get all cards and redistribute them
            const allCards = [...document.querySelectorAll('.storyboard-card')];
            console.log('Total cards found before redistribution:', allCards.length);
            
            // Remove all cards from DOM
            allCards.forEach(card => {
                card.remove();
                console.log('Removed card from DOM');
            });

            // Redistribute remaining cards
            let cardsRedistributed = 0;
            allCards.forEach((card, index) => {
                if (index !== selectedFrameIndex) {
                    const newIndex = index < selectedFrameIndex ? index : index - 1;
                    console.log(`Redistributing card ${index} to new position ${newIndex}`);
                    
                    if (newIndex < 4) {
                        console.log(`Adding card to row 1, position ${newIndex}`);
                        gridRow1.appendChild(card);
                        cardsRedistributed++;
                    } else if (newIndex < 8) {
                        console.log(`Adding card to row 2, position ${newIndex}`);
                        gridRow2.appendChild(card);
                        cardsRedistributed++;
                    } else if (gridRow3) {
                        console.log(`Adding card to row 3, position ${newIndex}`);
                        gridRow3.appendChild(card);
                        cardsRedistributed++;
                    }
                }
            });
            
            console.log('Total cards redistributed:', cardsRedistributed);

            // Check row 3 status
            if (gridRow3) {
                console.log('Row 3 children count:', gridRow3.children.length);
                if (gridRow3.children.length === 0) {
                    console.log('Removing empty row 3');
                    gridRow3.remove();
                }
            }

            // Hide context menu
            contextMenu.style.display = 'none';
            console.log('Context menu hidden');

            // Update scene numbers and indices
            console.log('Updating scene numbers');
            updateSceneNumbers();

            // Recreate add scene buttons
            console.log('Recreating add scene buttons');
            createAddSceneButtons();
            
            console.log('=== Frame Deletion Complete ===');
        }
    </script>
</body>
</html> 