<!DOCTYPE html>
<html lang="en">
<head>
    <script src="config.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brand DNA - Storyboarding V2</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Unbounded:wght@200..900&display=swap">
    <link rel="stylesheet" href="styles.css">
    <script src="nav-template.js"></script>
    <style>
        /* Custom styles for storyboard-v2 */
        .storyboard-results-container {
            width: 100%;
            max-width: 1400px;
            margin: 2rem auto;
            position: relative;
        }

        .storyboard-grid, .storyboard-grid-row2 {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 20px;
            position: relative; /* Added for positioning the add buttons */
        }
        
        .storyboard-grid-row2 {
            margin-top: 20px;
        }
        
        @media (max-width: 1200px) {
            .storyboard-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .storyboard-grid-row2 {
                grid-template-columns: repeat(2, 1fr);
                width: 100%;
            }
        }
        
        @media (max-width: 768px) {
            .storyboard-grid, 
            .storyboard-grid-row2 {
                grid-template-columns: 1fr;
                width: 100%;
            }
        }

        .storyboard-card {
            background: white;
            border-radius: 16px;
            padding: 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border: 1px solid;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            height: 100%; /* Ensure all cards have the same height */
        }

        .card-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 0 0 0.5rem 0;
        }

        .card-footer {
            padding: 0.5rem 1rem;
            border-top: 1px solid #f0f0f0;
            margin-top: auto; /* Push to bottom */
        }

        .storyboard-image {
            width: 100%;
            height: auto;
            border-radius: 0;
            display: block;
        }

        .storyboard-image-loading {
            width: 100%;
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f1f1f1;
            color: #666;
            border-radius: 4px;
        }

        .brand-card-title {
            margin-top: 0;
            margin-bottom: 0.5rem;
            padding: 0 1rem;
            font-size: 1rem;
        }

        .brand-card-body {
            padding: 0 1rem;
            font-size: 0.85rem;
            color: #444;
            line-height: 1.4;
            max-height: none;
            overflow-y: auto;
            flex-grow: 1; /* Allow the body to grow */
        }
        
        .creator-select-container {
            display: flex;
            gap: 1rem;
            margin-bottom: 0rem;
            margin-top: 1rem;
            align-items: center;
            max-width: 800px;
            width: 100%;
        }

        .creator-select-box {
            flex-grow: 1;
            position: relative;
            border: 1px solid #ddd;
            border-radius: 24px;
            background: white;
            overflow: visible;
            display: flex;
            align-items: center;
        }

        .creator-input {
            width: 100%;
            padding: 0.8rem 1.5rem;
            font-family: 'Unbounded', sans-serif;
            border: none;
            outline: none;
            background: transparent;
        }

        .creator-dropdown-arrow {
            width: 28px;
            height: 28px;
            cursor: pointer;
            transition: transform 0.2s ease;
            padding: 0px;
            opacity: 0.7;
            margin-right: 1rem;
        }

        .creator-dropdown-arrow:hover {
            opacity: 1.0;
        }

        .creator-dropdown-menu {
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            width: 100%;
            max-height: 16.5rem;
            overflow-y: auto;
            background: white;
            border: 1px solid #ddd;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            z-index: 1000;
            display: none;
        }

        .creator-dropdown-menu.active {
            display: block;
        }

        .creator-dropdown-item {
            padding: 1rem 1.5rem;
            font-family: 'Unbounded', sans-serif;
            font-size: 0.9rem;
            color: #26201F;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            height: 3.2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .image-wrapper {
            position: relative;
            width: 100%;
            margin-bottom: 0;
        }

        .download-button {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background-color: rgba(0, 0, 0, 0.2);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s ease;
            padding: 6px;
            z-index: 1;
        }

        .download-button:hover {
            background-color: rgba(0, 0, 0, 0.3);
        }

        .download-button svg {
            width: 20px;
            height: 20px;
        }

        .scene-number {
            padding: 0 1rem;
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 0.25rem;
            margin-top: 0.5rem;
        }

        .prompt-section {
            padding: 0 1rem;
            margin-top: 0.5rem;
            display: none;
        }

        .prompt-button {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            font-family: 'Unbounded', sans-serif;
            font-size: 0.8rem;
            padding: 0.5rem 0;
        }

        .prompt-button:hover {
            color: #000;
        }

        .chevron-icon {
            transition: transform 0.2s ease;
        }

        .prompt-button.expanded .chevron-icon {
            transform: rotate(180deg);
        }

        .prompt-content {
            font-size: 0.85rem;
            color: #666;
            background: #f8f8f8;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 0.5rem;
            white-space: pre-wrap;
            display: none;
        }

        .search-row {
            display: flex;
            gap: 1rem;
            max-width: 800px;
            width: 100%;
            margin-bottom: 1rem;
        }

        .search-row + .search-row {
            margin-top: 0rem;
        }

        .integration-select {
            width: 180px;
            padding: 0.8rem 1.5rem;
            font-family: 'Unbounded', sans-serif;
            border: 1px solid #ddd;
            border-radius: 24px;
            background: white;
            outline: none;
            cursor: pointer;
            font-size: 0.9rem;
            appearance: none;
            background-image: url('/icons/drop_down.svg');
            background-repeat: no-repeat;
            background-position: calc(100% - 1rem) center;
            background-size: 28px;
        }

        .integration-select option[value=""] {
            color: #999;
        }

        .integration-select.placeholder {
            color: #999;
        }

        .integration-select:not(.placeholder) {
            color: #26201F;
        }

        .regenerate-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            font-family: 'Unbounded', sans-serif;
            font-size: 0.8rem;
            padding: 0;
            margin: 0;
            transition: all 0.2s ease;
            width: 100%;
            justify-content: center;
        }

        .regenerate-btn:hover {
            color: #000;
        }

        .regenerate-icon {
            width: 20px;
            height: 20px;
            transition: transform 0.3s ease;
        }

        .regenerate-btn:hover .regenerate-icon {
            transform: rotate(180deg);
        }

        .feedback-container {
            padding: 1rem;
            margin-top: 0;
            display: none;
            border-top: 1px solid #f0f0f0;
            background-color: #f9f9f9;
        }

        .feedback-textarea {
            width: 100%;
            min-height: 80px;
            padding: 0.8rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-family: 'Unbounded', sans-serif;
            font-size: 0.8rem;
            resize: vertical;
            margin-bottom: 1rem;
        }

        .feedback-actions {
            display: flex;
            justify-content: space-between;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .submit-feedback-btn, .cancel-feedback-btn {
            padding: 0.5rem 1rem;
            border-radius: 16px;
            font-family: 'Unbounded', sans-serif;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
            flex: 1;
        }

        .submit-feedback-btn {
            background: linear-gradient(90deg, #F53151 0%, #F742BD 100%);
            color: white;
            border: none;
        }

        .submit-feedback-btn:hover {
            opacity: 0.9;
        }

        .cancel-feedback-btn {
            background: #f5f5f5;
            border: 1px solid #ddd;
        }

        .cancel-feedback-btn:hover {
            background: #e9e9e9;
        }

        .regenerating-indicator {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            z-index: 20;
            border-radius: 8px;
        }

        .regenerating-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Add scene button styles */
        .add-scene-button {
            position: absolute;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.7);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            transform: translate(-50%, -50%);
            transition: background 0.3s ease;
            opacity: 0; /* Hide by default */
        }

        .add-scene-button:hover {
            background: linear-gradient(90deg, #F53151 0%, #F742BD 100%);
        }

        /* Show buttons when hovering over the container */
        .storyboard-results-container:hover .add-scene-button {
            opacity: 1;
        }

        /* Keep button visible when hovering directly over it */
        .add-scene-button:hover {
            opacity: 1;
        }

        .add-scene-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            z-index: 1000;
        }

        .popup-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
        }

        .popup-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 2rem;
            border-radius: 8px;
            width: 400px;
            max-width: 90%;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        .popup-content h3 {
            margin-top: 0;
            margin-bottom: 1rem;
            color: #333;
        }

        .popup-content textarea {
            width: 100%;
            min-height: 120px;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 1rem;
            font-family: inherit;
            resize: vertical;
        }

        .popup-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }

        .add-scene-confirm-btn {
            background: linear-gradient(90deg, #F53151 0%, #F742BD 100%);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 24px;
            cursor: pointer;
            font-weight: 500;
        }

        .add-scene-cancel-btn {
            background: #f1f1f1;
            color: #333;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 24px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="nav-placeholder"></div>
        <main class="content">
            <div class="search-row">
                <div class="search-box" style="flex: 0.4;">
                    <input type="text" placeholder="Campaign brief/goal..." class="brand-input" id="campaignBrief">
                </div>
                <div class="search-box" style="flex: 0.6;">
                    <input type="text" placeholder="Describe your video concept..." class="brand-input" id="videoConcept" data-translation-key="storyboard-concept-placeholder">
                </div>
            </div>
            <div class="search-row">
                <select class="integration-select placeholder" id="integrationType" style="width: 200px; flex: 0.3;">
                    <option value="" disabled selected data-translation-key="storyboard-integration-placeholder">Integration</option>
                    <option value="brand_mention" data-translation-key="integration-mention">Mention</option>
                    <option value="mid_video" data-translation-key="integration-adbreak">Ad Break</option>
                    <option value="full_integration" data-translation-key="integration-full">Full Integration</option>
                </select>
                <div class="creator-select-box" style="flex: 0.7;">
                    <input type="text" placeholder="Select a creator..." class="creator-input" id="creatorInput" readonly data-translation-key="storyboard-creator-placeholder">
                    <img src="/icons/drop_down.svg" alt="Dropdown" class="creator-dropdown-arrow" id="creatorDropdownArrow">
                    <div class="creator-dropdown-menu" id="creatorDropdown"></div>
                </div>
                <button class="get-dna-btn" onclick="generateStoryboard()" style="flex-shrink: 0;" data-translation-key="storyboard-generate-button">GENERATE STORYBOARD</button>
            </div>
            
            <div class="loading-container">
                <div class="loading-spinner"></div>
                <div class="loading-text">generating...</div>
            </div>
            
            <div class="storyboard-results-container">
                <div class="storyboard-grid" id="storyboardGridRow1">
                    <!-- First 4 frames will be added here -->
                </div>
                <div class="storyboard-grid-row2" id="storyboardGridRow2">
                    <!-- Last 3 frames will be added here -->
                </div>
            </div>
        </main>
    </div>

    <script>
        let selectedCreatorDNA = null;
        let currentStoryboard = [];

        document.addEventListener('DOMContentLoaded', async () => {
            await translateUI();
            
            // Hide other navigation items except for storyboarding
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                // Only show the storyboarding nav item

                    item.style.display = 'none';
            });

            // Dropdown handling
            const dropdownArrow = document.getElementById('creatorDropdownArrow');
            const dropdownMenu = document.getElementById('creatorDropdown');

            dropdownArrow.addEventListener('click', async (e) => {
                e.stopPropagation();
                dropdownMenu.classList.toggle('active');
                if (dropdownMenu.classList.contains('active')) {
                    await loadCreatorOptions();
                }
            });

            document.addEventListener('click', (e) => {
                if (!dropdownMenu.contains(e.target) && !dropdownArrow.contains(e.target)) {
                    dropdownMenu.classList.remove('active');
                }
            });

            // Handle placeholder state for integration select
            const integrationSelect = document.getElementById('integrationType');
            
            integrationSelect.addEventListener('change', function() {
                if (this.value) {
                    this.classList.remove('placeholder');
                } else {
                    this.classList.add('placeholder');
                }
            });

            // Check for URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const concept = urlParams.get('concept');
            const integration = urlParams.get('integration');
            const creator = urlParams.get('creator');

            if (concept && integration && creator) {
                // Set the concept
                document.getElementById('videoConcept').value = decodeURIComponent(concept);

                // Set the integration type
                document.getElementById('integrationType').value = integration;
                document.getElementById('integrationType').classList.remove('placeholder');

                // First, set creator input value
                document.getElementById('creatorInput').value = decodeURIComponent(creator);

                // Then load creator options and set selected creator
                loadCreatorOptions().then(async () => {
                    // Get creator data
                    const response = await fetch(`${window.API_BASE_URL}/getCreatorDNAs`);
                    const creators = await response.json();

                    // Set the selected creator DNA
                    selectedCreatorDNA = creators[decodeURIComponent(creator)];

                    // Generate the storyboard after a short delay
                    setTimeout(() => {
                        generateStoryboard();
                    }, 500);
                });
            }
        });

        async function loadCreatorOptions() {
            try {
                const response = await fetch(`${window.API_BASE_URL}/getCreatorDNAs`);
                const creators = await response.json();
                const dropdownMenu = document.getElementById('creatorDropdown');
                dropdownMenu.innerHTML = '';

                const sortedCreatorNames = Object.keys(creators).sort((a, b) =>
                    a.toLowerCase().localeCompare(b.toLowerCase())
                );

                sortedCreatorNames.forEach(creatorName => {
                    const item = document.createElement('div');
                    item.className = 'creator-dropdown-item';
                    item.textContent = creatorName;
                    item.addEventListener('click', () => {
                        selectedCreatorDNA = creators[creatorName];
                        document.getElementById('creatorInput').value = creatorName;
                        dropdownMenu.classList.remove('active');
                    });
                    dropdownMenu.appendChild(item);
                });
            } catch (error) {
                console.error('Error loading creators:', error);
            }
        }

        async function generateStoryboard() {
            const campaignBrief = document.getElementById('campaignBrief').value.trim();
            const videoConcept = document.getElementById('videoConcept').value.trim();
            const integrationType = document.getElementById('integrationType').value;
            const loadingContainer = document.querySelector('.loading-container');
            const storyboardContainer = document.querySelector('.storyboard-results-container');
            
            if (!videoConcept) {
                alert('Please enter a video concept');
                return;
            }

            if (!integrationType) {
                alert('Please select an integration type');
                return;
            }

            if (!selectedCreatorDNA) {
                alert('Please select a creator');
                return;
            }

            const currentBrandDNA = getClientDNA();
            if (!currentBrandDNA) {
                alert('Please select a brand DNA');
                return;
            }

            // Create an integration type description map
            const integrationDescriptions = {
                brand_mention: "A short (15-30 second) acknowledgement of the brand within the video, usually involving a brief description and call to action.",
                mid_video: "A distinct 30-60 second (or longer) promotional segment in the middle of the video, where the creator directly promotes the brand and its products.",
                full_integration: "The brand's product or service is seamlessly woven into the video's core content, acting as a central element of the story, tutorial, or challenge."
            };

            try {
                loadingContainer.style.display = 'flex';
                storyboardContainer.innerHTML = `
                    <div class="storyboard-grid" id="storyboardGridRow1">
                        <!-- First 4 frames will be added here -->
                    </div>
                    <div class="storyboard-grid-row2" id="storyboardGridRow2">
                        <!-- Last 3 frames will be added here -->
                    </div>
                `;
                
                const gridRow1 = document.getElementById('storyboardGridRow1');
                const gridRow2 = document.getElementById('storyboardGridRow2');
                
                gridRow1.innerHTML = '';
                gridRow2.innerHTML = '';

                const clientLanguage = getClientLanguage();
                console.log('Client language detected:', clientLanguage);
                
                const requestBody = {
                    campaignBrief: campaignBrief + " (This describes the brand's marketing objectives and goals for this campaign)",
                    videoConcept: videoConcept + " (This describes the actual content and storyline of the video)",
                    brandDNA: currentBrandDNA,
                    creatorDNA: selectedCreatorDNA,
                    integrationType: {
                        type: integrationType,
                        description: integrationDescriptions[integrationType]
                    },
                    language: clientLanguage,
                    version: 'v2' // Specify that we want the v2 version with 7 scenes
                };
                
                console.log('Sending storyboard request with language:', clientLanguage);

                const response = await fetch(`${window.API_BASE_URL}/generateStoryboard`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                const cleanJSON = data.replace(/```json\n|\n```/g, '').trim();
                const storyboard = JSON.parse(cleanJSON).storyboard;
                
                // Store the current storyboard data
                currentStoryboard = storyboard;

                // Extract image prompts
                const imagePrompts = storyboard.map(act => act.image_prompt);
                
                console.log('Sending image generation request with language:', clientLanguage);

                // Generate images for all prompts
                const imageResponse = await fetch(`${window.API_BASE_URL}/generateStoryboardImages`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        imagePrompts,
                        language: getClientLanguage()
                    })
                });

                if (!imageResponse.ok) {
                    throw new Error(`HTTP error! status: ${imageResponse.status}`);
                }

                const imageData = await imageResponse.json();

                loadingContainer.style.display = 'none';

                // Create cards with both content and images
                storyboard.forEach((act, index) => {
                    const card = document.createElement('div');
                    card.className = 'storyboard-card';
                    card.style.borderColor = currentBrandDNA.brandColors[0];
                    card.dataset.index = index;

                    // Create content section
                    const cardContent = document.createElement('div');
                    cardContent.className = 'card-content';

                    // Add the generated image
                    if (imageData.images[index]) {
                        const imageWrapper = document.createElement('div');
                        imageWrapper.className = 'image-wrapper';

                        const img = document.createElement('img');
                        img.src = `data:image/png;base64,${imageData.images[index]}`;
                        img.className = 'storyboard-image';

                        // Create download button
                        const downloadButton = document.createElement('button');
                        downloadButton.className = 'download-button';
                        downloadButton.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="white">
                                <path d="M480-320 280-520l56-58 104 104v-326h80v326l104-104 56 58-200 200ZM240-160q-33 0-56.5-23.5T160-240v-120h80v120h480v-120h80v120q0 33-23.5 56.5T720-160H240Z"/>
                            </svg>
                        `;

                        downloadButton.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const link = document.createElement('a');
                            link.href = img.src;
                            link.download = `storyboard-scene-${index + 1}.png`;
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                        });

                        imageWrapper.appendChild(img);
                        imageWrapper.appendChild(downloadButton);
                        cardContent.appendChild(imageWrapper);
                    }

                    // Create scene number
                    const sceneNumber = document.createElement('div');
                    sceneNumber.className = 'scene-number';
                    const sceneKey = `scene-${index + 1}`;
                    sceneNumber.setAttribute('data-translation-key', sceneKey);
                    sceneNumber.textContent = `Scene ${index + 1}`;

                    const title = document.createElement('h2');
                    title.className = 'brand-card-title';
                    title.textContent = act.act_title;

                    const body = document.createElement('div');
                    body.className = 'brand-card-body';
                    body.textContent = act.act_description;

                    // Create prompt reveal section
                    const promptSection = document.createElement('div');
                    promptSection.className = 'prompt-section';

                    const promptButton = document.createElement('button');
                    promptButton.className = 'prompt-button';
                    promptButton.innerHTML = `
                        <span data-translation-key="storyboard-show-prompt">Show Prompt</span>
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="chevron-icon">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                    `;

                    const promptContent = document.createElement('div');
                    promptContent.className = 'prompt-content';
                    promptContent.textContent = act.image_prompt;

                    promptButton.addEventListener('click', () => {
                        const isExpanded = promptContent.style.display !== 'none';
                        promptContent.style.display = isExpanded ? 'none' : 'block';
                        promptButton.classList.toggle('expanded');
                    });

                    promptSection.appendChild(promptButton);
                    promptSection.appendChild(promptContent);

                    // Add elements to the card content
                    cardContent.appendChild(sceneNumber);
                    cardContent.appendChild(title);
                    cardContent.appendChild(body);
                    cardContent.appendChild(promptSection);
                    
                    // Add the card content to the card
                    card.appendChild(cardContent);
                    
                    // Create card footer
                    const cardFooter = document.createElement('div');
                    cardFooter.className = 'card-footer';
                    
                    // Add regenerate button to the footer
                    const regenerateBtn = document.createElement('button');
                    regenerateBtn.className = 'regenerate-btn';
                    regenerateBtn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="#666" class="regenerate-icon">
                            <path d="M482-160q-134 0-228-93t-94-227v-7l-64 64-56-56 160-160 160 160-56 56-64-64v7q0 100 70.5 170T482-240q26 0 51-6t49-18l60 60q-38 22-78 33t-82 11Zm278-161L600-481l56-56 64 64v-7q0-100-70.5-170T478-720q-26 0-51 6t-49 18l-60-60q38-22 78-33t82-11q134 0 228 93t94 227v7l64-64 56 56-160 160Z"/>
                        </svg>
                        <span>Regenerate Frame</span>
                    `;
                    regenerateBtn.addEventListener('click', () => toggleFeedbackArea(index));
                    cardFooter.appendChild(regenerateBtn);
                    
                    // Add the footer to the card
                    card.appendChild(cardFooter);
                    
                    // Add feedback container
                    const feedbackContainer = document.createElement('div');
                    feedbackContainer.className = 'feedback-container';
                    feedbackContainer.id = `feedback-container-${index}`;
                    
                    const feedbackTextarea = document.createElement('textarea');
                    feedbackTextarea.className = 'feedback-textarea';
                    feedbackTextarea.placeholder = 'Describe how you want to change this frame...';
                    feedbackTextarea.id = `feedback-textarea-${index}`;
                    
                    const feedbackActions = document.createElement('div');
                    feedbackActions.className = 'feedback-actions';
                    
                    const submitBtn = document.createElement('button');
                    submitBtn.className = 'submit-feedback-btn';
                    submitBtn.textContent = 'Submit';
                    submitBtn.addEventListener('click', () => regenerateFrame(index));
                    
                    const cancelBtn = document.createElement('button');
                    cancelBtn.className = 'cancel-feedback-btn';
                    cancelBtn.textContent = 'Cancel';
                    cancelBtn.addEventListener('click', () => toggleFeedbackArea(index));
                    
                    feedbackActions.appendChild(submitBtn);
                    feedbackActions.appendChild(cancelBtn);
                    
                    feedbackContainer.appendChild(feedbackTextarea);
                    feedbackContainer.appendChild(feedbackActions);
                    
                    card.appendChild(feedbackContainer);
                    
                    // Add regenerating indicator
                    const regeneratingIndicator = document.createElement('div');
                    regeneratingIndicator.className = 'regenerating-indicator';
                    regeneratingIndicator.id = `regenerating-indicator-${index}`;
                    
                    const spinner = document.createElement('div');
                    spinner.className = 'regenerating-spinner';
                    
                    const text = document.createElement('div');
                    text.textContent = 'Regenerating frame...';
                    
                    regeneratingIndicator.appendChild(spinner);
                    regeneratingIndicator.appendChild(text);
                    
                    card.appendChild(regeneratingIndicator);
                    
                    // Add to the appropriate row
                    if (index < 4) {
                        gridRow1.appendChild(card);
                    } else if (index < 8) {
                        gridRow2.appendChild(card);
                    } else {
                        // If we have more than 8 cards, create a third row if needed
                        let gridRow3 = document.getElementById('storyboardGridRow3');
                        if (!gridRow3) {
                            gridRow3 = document.createElement('div');
                            gridRow3.className = 'storyboard-grid';
                            gridRow3.id = 'storyboardGridRow3';
                            storyboardContainer.appendChild(gridRow3);
                        }
                        gridRow3.appendChild(card);
                    }
                });
                
                await translateUI();

                // Set up event listeners for all cards
                setupCardEventListeners();

                // Create add scene buttons after cards are created
                setTimeout(createAddSceneButtons, 500);

            } catch (error) {
                console.error('Error:', error);
                loadingContainer.style.display = 'none';
                alert(`Error: ${error.message}`);
            }
        }

        // Function to toggle the feedback area
        function toggleFeedbackArea(index) {
            const feedbackContainer = document.getElementById(`feedback-container-${index}`);
            if (feedbackContainer.style.display === 'block') {
                feedbackContainer.style.display = 'none';
            } else {
                feedbackContainer.style.display = 'block';
            }
        }
        
        // Function to regenerate a single frame
        async function regenerateFrame(index) {
            const feedbackText = document.getElementById(`feedback-textarea-${index}`).value.trim();
            if (!feedbackText) {
                alert('Please provide feedback on how to change the frame.');
                return;
            }
            
            const regeneratingIndicator = document.getElementById(`regenerating-indicator-${index}`);
            regeneratingIndicator.style.display = 'flex';
            
            try {
                const campaignBrief = document.getElementById('campaignBrief').value.trim();
                const videoConcept = document.getElementById('videoConcept').value.trim();
                const integrationType = document.getElementById('integrationType').value;
                const currentBrandDNA = getClientDNA();
                
                // Create an integration type description map
                const integrationDescriptions = {
                    brand_mention: "A short (15-30 second) acknowledgement of the brand within the video, usually involving a brief description and call to action.",
                    mid_video: "A distinct 30-60 second (or longer) promotional segment in the middle of the video, where the creator directly promotes the brand and its products.",
                    full_integration: "The brand's product or service is seamlessly woven into the video's core content, acting as a central element of the story, tutorial, or challenge."
                };
                
                const requestBody = {
                    campaignBrief: campaignBrief + " (This describes the brand's marketing objectives and goals for this campaign)",
                    videoConcept: videoConcept + " (This describes the actual content and storyline of the video)",
                    brandDNA: currentBrandDNA,
                    creatorDNA: selectedCreatorDNA,
                    integrationType: {
                        type: integrationType,
                        description: integrationDescriptions[integrationType]
                    },
                    language: getClientLanguage(),
                    storyboard: currentStoryboard,
                    frameIndex: index,
                    feedback: feedbackText
                };
                
                const response = await fetch(`${window.API_BASE_URL}/regenerateStoryboardFrame`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Update the storyboard data
                currentStoryboard[index] = data.frame;
                
                // Generate the new image
                const imageResponse = await fetch(`${window.API_BASE_URL}/generateStoryboardImages`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        imagePrompts: [data.frame.image_prompt],
                        language: getClientLanguage()
                    })
                });
                
                if (!imageResponse.ok) {
                    throw new Error(`HTTP error! status: ${imageResponse.status}`);
                }
                
                const imageData = await imageResponse.json();
                
                // Update the card with new content
                const card = document.querySelector(`.storyboard-card[data-index="${index}"]`);
                
                // Update image
                const img = card.querySelector('.storyboard-image');
                if (img && imageData.images[0]) {
                    img.src = `data:image/png;base64,${imageData.images[0]}`;
                }
                
                // Update title and description
                const title = card.querySelector('.brand-card-title');
                const body = card.querySelector('.brand-card-body');
                
                if (title) title.textContent = data.frame.act_title;
                if (body) body.textContent = data.frame.act_description;
                
                // Hide the feedback area
                document.getElementById(`feedback-container-${index}`).style.display = 'none';
                
            } catch (error) {
                console.error('Error regenerating frame:', error);
                alert(`Error: ${error.message}`);
            } finally {
                regeneratingIndicator.style.display = 'none';
            }
        }

        // Function to create add scene buttons
        function createAddSceneButtons() {
            // Remove any existing add buttons
            document.querySelectorAll('.add-scene-button').forEach(btn => btn.remove());
            
            const storyboardCards = document.querySelectorAll('.storyboard-card');
            if (storyboardCards.length === 0) return;
            
            const gridContainer = document.querySelector('.storyboard-results-container');
            const gridRect = gridContainer.getBoundingClientRect();
            
            // Remove any existing popup before creating a new one
            const existingPopup = document.querySelector('.add-scene-popup');
            if (existingPopup) {
                existingPopup.remove();
            }
            
            // Create popup for adding new scenes
            const popup = document.createElement('div');
            popup.className = 'add-scene-popup';
            popup.id = 'addScenePopup';
            popup.innerHTML = `
                <div class="popup-overlay"></div>
                <div class="popup-content">
                    <h3>Add New Scene</h3>
                    <textarea placeholder="Describe the new scene you'd like to add..." id="new-scene-description"></textarea>
                    <div class="popup-actions">
                        <button class="add-scene-confirm-btn">Add Scene</button>
                        <button class="add-scene-cancel-btn">Cancel</button>
                    </div>
                </div>
            `;
            document.body.appendChild(popup);
            
            // Hide popup initially
            popup.style.display = 'none';
            
            // Add event listeners to popup buttons
            const confirmBtn = popup.querySelector('.add-scene-confirm-btn');
            const cancelBtn = popup.querySelector('.add-scene-cancel-btn');
            const overlay = popup.querySelector('.popup-overlay');
            
            cancelBtn.addEventListener('click', () => {
                popup.style.display = 'none';
            });
            
            overlay.addEventListener('click', () => {
                popup.style.display = 'none';
            });
            
            // Add event listener to confirm button with direct access to the textarea
            confirmBtn.addEventListener('click', () => {
                const description = document.getElementById('new-scene-description').value.trim();
                
                if (!description) {
                    alert('Please enter a description for the new scene.');
                    return;
                }
                
                const position = popup.dataset.position;
                const index = parseInt(popup.dataset.index);
                
                // Add the placeholder card
                addPlaceholderCard(position, index, description);
                
                // Hide popup
                popup.style.display = 'none';
            });
            
            // Create a button before the first card
            const firstCard = storyboardCards[0];
            const firstCardRect = firstCard.getBoundingClientRect();
            
            const beforeButton = document.createElement('button');
            beforeButton.className = 'add-scene-button';
            beforeButton.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24">
                    <path d="M440-440H200v-80h240v-240h80v240h240v80H520v240h-80v-240Z" fill="white"/>
                </svg>
            `;
            
            // Position the button to the left of the first card
            const leftPosition = firstCardRect.left - gridRect.left - 30; // 30px to the left
            const midpointY = (firstCardRect.top + firstCardRect.bottom) / 2 - gridRect.top;
            
            beforeButton.style.left = `${leftPosition}px`;
            beforeButton.style.top = `${midpointY}px`;
            
            // Add data attribute to track position
            beforeButton.dataset.position = 'before';
            beforeButton.dataset.index = '0';
            
            gridContainer.appendChild(beforeButton);
            
            // Create buttons between cards in the first row
            for (let i = 0; i < storyboardCards.length - 1; i++) {
                const card1 = storyboardCards[i];
                const card2 = storyboardCards[i + 1];
                
                // Skip if cards are not in the same row
                if (i === 3) continue; // Skip between rows
                
                const rect1 = card1.getBoundingClientRect();
                const rect2 = card2.getBoundingClientRect();
                
                const betweenButton = document.createElement('button');
                betweenButton.className = 'add-scene-button';
                betweenButton.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24">
                        <path d="M440-440H200v-80h240v-240h80v240h240v80H520v240h-80v-240Z" fill="white"/>
                    </svg>
                `;
                
                // Position the button between the cards
                const midpointX = (rect1.right + rect2.left) / 2 - gridRect.left;
                const midpointY = (rect1.top + rect1.bottom) / 2 - gridRect.top;
                
                betweenButton.style.left = `${midpointX}px`;
                betweenButton.style.top = `${midpointY}px`;
                
                // Add data attribute to track position
                betweenButton.dataset.position = 'between';
                betweenButton.dataset.index = `${i + 1}`;
                
                gridContainer.appendChild(betweenButton);
            }
            
            // Create buttons between cards in the second row
            const gridContainer2 = document.querySelector('.storyboard-results-container');
            const gridRect2 = gridContainer2.getBoundingClientRect();
            
            for (let i = 4; i < storyboardCards.length - 1; i++) {
                const card1 = storyboardCards[i];
                const card2 = storyboardCards[i + 1];
                
                const rect1 = card1.getBoundingClientRect();
                const rect2 = card2.getBoundingClientRect();
                
                const betweenButton = document.createElement('button');
                betweenButton.className = 'add-scene-button';
                betweenButton.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24">
                        <path d="M440-440H200v-80h240v-240h80v240h240v80H520v240h-80v-240Z" fill="white"/>
                    </svg>
                `;
                
                // Position the button between the cards
                const midpointX = (rect1.right + rect2.left) / 2 - gridRect2.left;
                const midpointY = (rect1.top + rect1.bottom) / 2 - gridRect2.top;
                
                betweenButton.style.left = `${midpointX}px`;
                betweenButton.style.top = `${midpointY}px`;
                
                // Add data attribute to track position
                betweenButton.dataset.position = 'between';
                betweenButton.dataset.index = `${i + 1}`;
                
                gridContainer2.appendChild(betweenButton);
            }
            
            // Create a button after the last card
            const lastCard = storyboardCards[storyboardCards.length - 1];
            const lastCardRect = lastCard.getBoundingClientRect();
            
            const afterButton = document.createElement('button');
            afterButton.className = 'add-scene-button';
            afterButton.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24">
                    <path d="M440-440H200v-80h240v-240h80v240h240v80H520v240h-80v-240Z" fill="white"/>
                </svg>
            `;
            
            // Position the button to the right of the last card
            const rightPosition = lastCardRect.right - gridRect.left + 30; // 30px to the right
            const lastMidpointY = (lastCardRect.top + lastCardRect.bottom) / 2 - gridRect.top;
            
            afterButton.style.left = `${rightPosition}px`;
            afterButton.style.top = `${lastMidpointY}px`;
            
            // Add data attribute to track position
            afterButton.dataset.position = 'after';
            afterButton.dataset.index = `${storyboardCards.length}`;
            
            gridContainer.appendChild(afterButton);
            
            // Add event listeners to all add buttons
            document.querySelectorAll('.add-scene-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    // Show popup
                    popup.style.display = 'block';
                    
                    // Store the button's position and index in the popup
                    popup.dataset.position = button.dataset.position;
                    popup.dataset.index = button.dataset.index;
                    
                    // Clear any previous input
                    document.getElementById('new-scene-description').value = '';
                });
            });
        }

        // Function to add a placeholder card at the specified position
        function addPlaceholderCard(position, index, description) {
            const currentBrandDNA = getClientDNA();
            const placeholderCard = createPlaceholderCard(description, currentBrandDNA);
            
            const gridRow1 = document.getElementById('storyboardGridRow1');
            const gridRow2 = document.getElementById('storyboardGridRow2');
            let gridRow3 = document.getElementById('storyboardGridRow3');
            
            // Create third row if needed
            if (!gridRow3 && (gridRow1.children.length + gridRow2.children.length) >= 8) {
                gridRow3 = document.createElement('div');
                gridRow3.className = 'storyboard-grid';
                gridRow3.id = 'storyboardGridRow3';
                document.querySelector('.storyboard-results-container').appendChild(gridRow3);
            }
            
            // Insert the card at the appropriate position
            if (position === 'before') {
                // Insert before the first card
                if (gridRow1.children.length > 0) {
                    gridRow1.insertBefore(placeholderCard, gridRow1.children[0]);
                } else {
                    gridRow1.appendChild(placeholderCard);
                }
                
                // If first row now has more than 4 cards, move the last one to the second row
                if (gridRow1.children.length > 4) {
                    const lastCard = gridRow1.children[4];
                    gridRow1.removeChild(lastCard);
                    if (gridRow2.children.length > 0) {
                        gridRow2.insertBefore(lastCard, gridRow2.children[0]);
                    } else {
                        gridRow2.appendChild(lastCard);
                    }
                    
                    // If second row now has more than 4 cards, move the last one to the third row
                    if (gridRow2.children.length > 4) {
                        const lastCard2 = gridRow2.children[4];
                        gridRow2.removeChild(lastCard2);
                        
                        if (!gridRow3) {
                            gridRow3 = document.createElement('div');
                            gridRow3.className = 'storyboard-grid';
                            gridRow3.id = 'storyboardGridRow3';
                            document.querySelector('.storyboard-results-container').appendChild(gridRow3);
                        }
                        
                        gridRow3.appendChild(lastCard2);
                    }
                }
            } else if (position === 'between') {
                // Determine which row to insert into
                if (index < 4) {
                    // First row
                    if (index < gridRow1.children.length) {
                        gridRow1.insertBefore(placeholderCard, gridRow1.children[index]);
                    } else {
                        gridRow1.appendChild(placeholderCard);
                    }
                    
                    // If first row now has more than 4 cards, move the last one to the second row
                    if (gridRow1.children.length > 4) {
                        const lastCard = gridRow1.children[4];
                        gridRow1.removeChild(lastCard);
                        if (gridRow2.children.length > 0) {
                            gridRow2.insertBefore(lastCard, gridRow2.children[0]);
                        } else {
                            gridRow2.appendChild(lastCard);
                        }
                        
                        // If second row now has more than 4 cards, move the last one to the third row
                        if (gridRow2.children.length > 4) {
                            const lastCard2 = gridRow2.children[4];
                            gridRow2.removeChild(lastCard2);
                            
                            if (!gridRow3) {
                                gridRow3 = document.createElement('div');
                                gridRow3.className = 'storyboard-grid';
                                gridRow3.id = 'storyboardGridRow3';
                                document.querySelector('.storyboard-results-container').appendChild(gridRow3);
                            }
                            
                            gridRow3.appendChild(lastCard2);
                        }
                    }
                } else if (index < 8) {
                    // Second row
                    const secondRowIndex = index - 4;
                    if (secondRowIndex < gridRow2.children.length) {
                        gridRow2.insertBefore(placeholderCard, gridRow2.children[secondRowIndex]);
                    } else {
                        gridRow2.appendChild(placeholderCard);
                    }
                    
                    // If second row now has more than 4 cards, move the last one to the third row
                    if (gridRow2.children.length > 4) {
                        const lastCard = gridRow2.children[4];
                        gridRow2.removeChild(lastCard);
                        
                        if (!gridRow3) {
                            gridRow3 = document.createElement('div');
                            gridRow3.className = 'storyboard-grid';
                            gridRow3.id = 'storyboardGridRow3';
                            document.querySelector('.storyboard-results-container').appendChild(gridRow3);
                        }
                        
                        if (gridRow3.children.length > 0) {
                            gridRow3.insertBefore(lastCard, gridRow3.children[0]);
                        } else {
                            gridRow3.appendChild(lastCard);
                        }
                    }
                } else {
                    // Third row
                    if (!gridRow3) {
                        gridRow3 = document.createElement('div');
                        gridRow3.className = 'storyboard-grid';
                        gridRow3.id = 'storyboardGridRow3';
                        document.querySelector('.storyboard-results-container').appendChild(gridRow3);
                    }
                    
                    const thirdRowIndex = index - 8;
                    if (thirdRowIndex < gridRow3.children.length) {
                        gridRow3.insertBefore(placeholderCard, gridRow3.children[thirdRowIndex]);
                    } else {
                        gridRow3.appendChild(placeholderCard);
                    }
                }
            } else if (position === 'after') {
                // Insert after the last card
                const totalCards = gridRow1.children.length + gridRow2.children.length + (gridRow3 ? gridRow3.children.length : 0);
                
                if (gridRow1.children.length < 4) {
                    gridRow1.appendChild(placeholderCard);
                } else if (gridRow2.children.length < 4) {
                    gridRow2.appendChild(placeholderCard);
                } else {
                    if (!gridRow3) {
                        gridRow3 = document.createElement('div');
                        gridRow3.className = 'storyboard-grid';
                        gridRow3.id = 'storyboardGridRow3';
                        document.querySelector('.storyboard-results-container').appendChild(gridRow3);
                    }
                    gridRow3.appendChild(placeholderCard);
                }
            }
            
            // Create a new frame object for the storyboard data
            const newFrame = {
                act_title: "New Scene",
                act_description: description,
                image_prompt: "Generating...",
                image_url: ""
            };
            
            // Update the storyboard data
            let newIndex = 0;
            if (position === 'before') {
                currentStoryboard.unshift(newFrame);
                newIndex = 0;
            } else if (position === 'between') {
                currentStoryboard.splice(index, 0, newFrame);
                newIndex = index;
            } else if (position === 'after') {
                currentStoryboard.push(newFrame);
                newIndex = currentStoryboard.length - 1;
            }
            
            // Update scene numbers
            updateSceneNumbers();
            
            // Add event listeners to the new card
            setupCardEventListeners();
            
            // Recreate add scene buttons
            createAddSceneButtons();
            
            // Generate the new scene content
            generateNewSceneContent(newIndex, description, position);
        }

        // Function to set up event listeners for all cards
        function setupCardEventListeners() {
            const cards = document.querySelectorAll('.storyboard-card');
            
            cards.forEach((card, index) => {
                // Set the card's index
                card.dataset.index = index;
                
                // Set up regenerate button
                const regenerateBtn = card.querySelector('.regenerate-btn');
                if (regenerateBtn) {
                    // Remove any existing event listeners
                    const newBtn = regenerateBtn.cloneNode(true);
                    regenerateBtn.parentNode.replaceChild(newBtn, regenerateBtn);
                    
                    // Add new event listener
                    newBtn.addEventListener('click', () => toggleFeedbackArea(index));
                }
                
                // Set up feedback container
                const feedbackContainer = card.querySelector('.feedback-container');
                if (feedbackContainer) {
                    feedbackContainer.id = `feedback-container-${index}`;
                    
                    // Set up textarea
                    const textarea = feedbackContainer.querySelector('.feedback-textarea');
                    if (textarea) {
                        textarea.id = `feedback-textarea-${index}`;
                    }
                    
                    // Set up submit button
                    const submitBtn = feedbackContainer.querySelector('.submit-feedback-btn');
                    if (submitBtn) {
                        // Remove any existing event listeners
                        const newSubmitBtn = submitBtn.cloneNode(true);
                        submitBtn.parentNode.replaceChild(newSubmitBtn, submitBtn);
                        
                        // Add new event listener
                        newSubmitBtn.addEventListener('click', () => regenerateFrame(index));
                    }
                    
                    // Set up cancel button
                    const cancelBtn = feedbackContainer.querySelector('.cancel-feedback-btn');
                    if (cancelBtn) {
                        // Remove any existing event listeners
                        const newCancelBtn = cancelBtn.cloneNode(true);
                        cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
                        
                        // Add new event listener
                        newCancelBtn.addEventListener('click', () => toggleFeedbackArea(index));
                    }
                }
                
                // Set up regenerating indicator
                const indicator = card.querySelector('.regenerating-indicator');
                if (indicator) {
                    indicator.id = `regenerating-indicator-${index}`;
                }
            });
        }

        // Function to create a placeholder card
        function createPlaceholderCard(description, brandDNA) {
            const card = document.createElement('div');
            card.className = 'storyboard-card';
            card.style.borderColor = brandDNA ? brandDNA.brandColors[0] : '#ccc';
            
            // Create content section
            const cardContent = document.createElement('div');
            cardContent.className = 'card-content';
            
            // Add placeholder image
            const imageWrapper = document.createElement('div');
            imageWrapper.className = 'image-wrapper';
            
            const placeholderImage = document.createElement('div');
            placeholderImage.className = 'storyboard-image-loading';
            placeholderImage.innerHTML = `
                <div style="text-align: center;">
                </div>
            `;
            
            imageWrapper.appendChild(placeholderImage);
            cardContent.appendChild(imageWrapper);
            
            // Create scene number (will be updated later)
            const sceneNumber = document.createElement('div');
            sceneNumber.className = 'scene-number';
            sceneNumber.textContent = 'New Scene';
            
            const title = document.createElement('h2');
            title.className = 'brand-card-title';
            title.textContent = 'New Scene';
            
            const body = document.createElement('div');
            body.className = 'brand-card-body';
            body.textContent = description;
            
            // Add elements to the card content
            cardContent.appendChild(sceneNumber);
            cardContent.appendChild(title);
            cardContent.appendChild(body);
            
            // Add the card content to the card
            card.appendChild(cardContent);
            
            // Create card footer
            const cardFooter = document.createElement('div');
            cardFooter.className = 'card-footer';
            
            // Add regenerate button to the footer
            const regenerateBtn = document.createElement('button');
            regenerateBtn.className = 'regenerate-btn';
            regenerateBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="#666" class="regenerate-icon">
                    <path d="M482-160q-134 0-228-93t-94-227v-7l-64 64-56-56 160-160 160 160-56 56-64-64v7q0 100 70.5 170T482-240q26 0 51-6t49-18l60 60q-38 22-78 33t-82 11Zm278-161L600-481l56-56 64 64v-7q0-100-70.5-170T478-720q-26 0-51 6t-49 18l-60-60q38-22 78-33t82-11q134 0 228 93t94 227v7l64-64 56 56-160 160Z"/>
                </svg>
                <span>Regenerate Frame</span>
            `;
            
            cardFooter.appendChild(regenerateBtn);
            card.appendChild(cardFooter);
            
            // Add feedback container
            const feedbackContainer = document.createElement('div');
            feedbackContainer.className = 'feedback-container';
            
            const feedbackTextarea = document.createElement('textarea');
            feedbackTextarea.className = 'feedback-textarea';
            feedbackTextarea.placeholder = 'Describe how you want to change this frame...';
            
            const feedbackActions = document.createElement('div');
            feedbackActions.className = 'feedback-actions';
            
            const submitBtn = document.createElement('button');
            submitBtn.className = 'submit-feedback-btn';
            submitBtn.textContent = 'Submit';
            
            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'cancel-feedback-btn';
            cancelBtn.textContent = 'Cancel';
            
            feedbackActions.appendChild(submitBtn);
            feedbackActions.appendChild(cancelBtn);
            
            feedbackContainer.appendChild(feedbackTextarea);
            feedbackContainer.appendChild(feedbackActions);
            
            card.appendChild(feedbackContainer);
            
            // Add regenerating indicator
            const regeneratingIndicator = document.createElement('div');
            regeneratingIndicator.className = 'regenerating-indicator';
            regeneratingIndicator.style.display = 'flex'; // Show the indicator immediately
            
            const spinner = document.createElement('div');
            spinner.className = 'regenerating-spinner';
            
            const text = document.createElement('div');
            text.textContent = 'Generating scene...';
            
            regeneratingIndicator.appendChild(spinner);
            regeneratingIndicator.appendChild(text);
            
            card.appendChild(regeneratingIndicator);
            
            return card;
        }

        // Function to generate content for a new scene
        async function generateNewSceneContent(index, description, position) {
            // Get the card element
            const card = document.querySelector(`.storyboard-card[data-index="${index}"]`);
            if (!card) return;
            
            // Show the regenerating indicator
            const regeneratingIndicator = card.querySelector('.regenerating-indicator');
            if (regeneratingIndicator) {
                regeneratingIndicator.style.display = 'flex';
            }
            
            try {
                const campaignBrief = document.getElementById('campaignBrief').value.trim();
                const videoConcept = document.getElementById('videoConcept').value.trim();
                const integrationType = document.getElementById('integrationType').value;
                const currentBrandDNA = getClientDNA();
                
                // Create an integration type description map
                const integrationDescriptions = {
                    brand_mention: "A short (15-30 second) acknowledgement of the brand within the video, usually involving a brief description and call to action.",
                    mid_video: "A distinct 30-60 second (or longer) promotional segment in the middle of the video, where the creator directly promotes the brand and its products.",
                    full_integration: "The brand's product or service is seamlessly woven into the video's core content, acting as a central element of the story, tutorial, or challenge."
                };
                
                // Create context for the new scene based on position
                let contextPrompt = "";
                if (position === 'before' && currentStoryboard.length > 1) {
                    contextPrompt = `This scene should come before the current first scene: "${currentStoryboard[1].act_title}: ${currentStoryboard[1].act_description}"`;
                } else if (position === 'between') {
                    const prevIndex = Math.max(0, index - 1);
                    const nextIndex = Math.min(currentStoryboard.length - 1, index + 1);
                    
                    if (prevIndex !== index && nextIndex !== index) {
                        contextPrompt = `This scene should fit between these two scenes: 
                        Before: "${currentStoryboard[prevIndex].act_title}: ${currentStoryboard[prevIndex].act_description}"
                        After: "${currentStoryboard[nextIndex].act_title}: ${currentStoryboard[nextIndex].act_description}"`;
                    }
                } else if (position === 'after' && index > 0) {
                    contextPrompt = `This scene should come after the current last scene: "${currentStoryboard[index-1].act_title}: ${currentStoryboard[index-1].act_description}"`;
                }
                
                const requestBody = {
                    campaignBrief: campaignBrief + " (This describes the brand's marketing objectives and goals for this campaign)",
                    videoConcept: videoConcept + " (This describes the actual content and storyline of the video)",
                    brandDNA: currentBrandDNA,
                    creatorDNA: selectedCreatorDNA,
                    integrationType: {
                        type: integrationType,
                        description: integrationDescriptions[integrationType]
                    },
                    language: getClientLanguage(),
                    storyboard: currentStoryboard,
                    frameIndex: index,
                    feedback: `Generate a new scene with this description: ${description}. ${contextPrompt}`
                };
                
                const response = await fetch(`${window.API_BASE_URL}/regenerateStoryboardFrame`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Update the storyboard data
                currentStoryboard[index] = data.frame;
                
                // Generate the new image
                const imageResponse = await fetch(`${window.API_BASE_URL}/generateStoryboardImages`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        imagePrompts: [data.frame.image_prompt],
                        language: getClientLanguage()
                    })
                });
                
                if (!imageResponse.ok) {
                    throw new Error(`HTTP error! status: ${imageResponse.status}`);
                }
                
                const imageData = await imageResponse.json();
                
                // Update the card with new content
                
                // Replace the placeholder image with the real image
                const imageWrapper = card.querySelector('.image-wrapper');
                if (imageWrapper) {
                    imageWrapper.innerHTML = ''; // Clear the placeholder
                    
                    const img = document.createElement('img');
                    img.src = `data:image/png;base64,${imageData.images[0]}`;
                    img.className = 'storyboard-image';
                    
                    // Create download button
                    const downloadButton = document.createElement('button');
                    downloadButton.className = 'download-button';
                    downloadButton.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="white">
                            <path d="M480-320 280-520l56-58 104 104v-326h80v326l104-104 56 58-200 200ZM240-160q-33 0-56.5-23.5T160-240v-120h80v120h480v-120h80v120q0 33-23.5 56.5T720-160H240Z"/>
                        </svg>
                    `;
                    
                    downloadButton.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const link = document.createElement('a');
                        link.href = img.src;
                        link.download = `storyboard-scene-${index + 1}.png`;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    });
                    
                    imageWrapper.appendChild(img);
                    imageWrapper.appendChild(downloadButton);
                }
                
                // Update title and description
                const title = card.querySelector('.brand-card-title');
                const body = card.querySelector('.brand-card-body');
                
                if (title) title.textContent = data.frame.act_title;
                if (body) body.textContent = data.frame.act_description;
                
                // Add prompt reveal section if it doesn't exist
                if (!card.querySelector('.prompt-section')) {
                    const cardContent = card.querySelector('.card-content');
                    if (cardContent) {
                        const promptSection = document.createElement('div');
                        promptSection.className = 'prompt-section';
                        
                        const promptButton = document.createElement('button');
                        promptButton.className = 'prompt-button';
                        promptButton.innerHTML = `
                            <span data-translation-key="storyboard-show-prompt">Show Prompt</span>
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="chevron-icon">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                        `;
                        
                        const promptContent = document.createElement('div');
                        promptContent.className = 'prompt-content';
                        promptContent.textContent = data.frame.image_prompt;
                        
                        promptButton.addEventListener('click', () => {
                            const isExpanded = promptContent.style.display !== 'none';
                            promptContent.style.display = isExpanded ? 'none' : 'block';
                            promptButton.classList.toggle('expanded');
                        });
                        
                        promptSection.appendChild(promptButton);
                        promptSection.appendChild(promptContent);
                        
                        cardContent.appendChild(promptSection);
                    }
                }
                
            } catch (error) {
                console.error('Error generating new scene content:', error);
                alert(`Error: ${error.message}`);
            } finally {
                // Hide the regenerating indicator
                if (regeneratingIndicator) {
                    regeneratingIndicator.style.display = 'none';
                }
            }
        }

        // Function to update all scene numbers
        function updateSceneNumbers() {
            const cards = document.querySelectorAll('.storyboard-card');
            
            cards.forEach((card, index) => {
                // Update the scene number text
                const sceneNumber = card.querySelector('.scene-number');
                if (sceneNumber) {
                    sceneNumber.textContent = `Scene ${index + 1}`;
                }
            });
            
            // Set up all event listeners with the new indices
            setupCardEventListeners();
        }
    </script>
</body>
</html> 