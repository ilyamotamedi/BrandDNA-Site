<!DOCTYPE html>
<html lang="en">
<head>
    <script src="config.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brand DNA - Match V2</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Unbounded:wght@200..900&display=swap">
    <link rel="stylesheet" href="styles.css">
    <script src="nav-template.js"></script>
    <style>
        /* Custom styles for match-v2 */
        .match-results {
            position: relative;
            overflow: visible;
            display: flex;
            flex-direction: column;
        }
        
        /* Full page layout with absolute positioning for DNA selector */
        .content {
            position: relative;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* Position the search container at the top */
        .search-container {
            margin-top: 0;
            position: relative;
            z-index: 5;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        /* Match type selector styles */
        .match-type-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            gap: 1rem;
        }
        
        .match-type-selector {
            display: flex;
            background-color: white;
            border-radius: 24px;
            padding: 0.25rem;
            position: relative;
            flex: 1;
            height: 40px;
            border: 1px solid #E0E0E0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .match-type-option {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem;
            cursor: pointer;
            border-radius: 20px;
            font-family: 'Unbounded', sans-serif;
            font-size: 0.8rem;
            font-weight: 500;
            color: #26201f37;
            z-index: 2;
            transition: color 0.3s ease;
        }
        
        .match-type-option.active {
            background: #26201F;
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-weight: 700;
        }
        
        .match-type-slider {
            position: absolute;
            height: calc(100% - 6px);
            width: 32%;
            background-color: #d8d8d8;
            border-radius: 18px;
            top: 3px;
            left: 3px;
            transition: transform 0.3s ease;
            z-index: 1;
        }
        
        .match-type-slider.position-1 {
            transform: translateX(0);
        }
        
        .match-type-slider.position-2 {
            transform: translateX(100%);
        }
        
        .match-type-slider.position-3 {
            transform: translateX(200%);
        }
        
        .search-input-container {
            display: flex;
            width: 100%;
            gap: 1rem;
        }
        
        /* Creator cards display styles */
        .creators-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 30px;
            margin-top: 2rem;
            padding: 0 1rem;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
        }
        
        @media (max-width: 768px) {
            .creators-container {
                grid-template-columns: 1fr;
            }
        }
        
        .creator-card {
            width: 100%;
            max-width: 100%;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
            transition: all 0.3s ease;
            position: relative;
            align-self: flex-start; /* Prevent cards from stretching to match heights */
        }
        
        .creator-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
        }
        
        .creator-card-header {
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s ease;
        }
        
        .creator-card-header:hover {
            background-color: #f9f9f9;
        }
        
        .creator-card-img {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .creator-card-info {
            flex: 1;
        }
        
        .creator-card-name {
            font-weight: 700;
            font-size: 1rem;
            margin-bottom: 0.25rem;
            color: #26201F;
        }
        
        .creator-card-subscribers {
            font-size: 0.8rem;
            color: #666;
        }
        
        .creator-card-grade {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 0.8rem;
            font-weight: 700;
            background: linear-gradient(to right, #F53151, #F742BD);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            padding: 2px 8px;
            border-radius: 10px;
        }
        
        .creator-card-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease;
        }
        
        .creator-card.expanded .creator-card-content {
            max-height: 2000px; /* Increased from 500px to accommodate more content */
        }
        
        .creator-card-section {
            padding: 1rem;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .creator-card-section:last-child {
            border-bottom: none;
        }
        
        .creator-card-section-title {
            font-size: 0.9rem;
            font-weight: 700;
            color: #26201F;
            margin-bottom: 0.5rem;
        }
        
        .creator-card-section-content {
            font-size: 0.85rem;
            color: #444;
            line-height: 1.4;
        }
        
        .creator-card-ideas {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }
        
        .creator-card-idea-item {
            margin-bottom: 0.75rem;
            padding-left: 1.5rem;
            position: relative;
            font-size: 0.85rem;
            transition: all 0.2s ease;
            padding-right: 1rem;
            border-radius: 4px;
        }
        
        .creator-card-idea-item:hover {
            background: linear-gradient(to right, rgba(245, 49, 81, 0.1), rgba(247, 66, 189, 0.1));
            padding: 0.5rem 1.5rem 0.5rem 1.5rem;
        }
        
        .creator-card-idea-item::before {
            content: "";
            position: absolute;
            left: 0;
            top: 0.5rem;
            width: 6px;
            height: 6px;
            background: linear-gradient(to right, #F53151, #F742BD);
            border-radius: 50%;
        }
        
        .creator-card-toggle {
            width: 100%;
            padding: 0.5rem;
            text-align: center;
            font-size: 0.8rem;
            color: #666;
            background-color: #ffffff;
            border: none;
            cursor: pointer;
        }
        
        .creator-card-toggle::after {
            content: "▼";
            margin-left: 5px;
            font-size: 0.7rem;
        }
        
        .creator-card.expanded .creator-card-toggle::after {
            content: "▲";
        }
        
        /* Feedback input and regenerate button styles */
        .ideas-feedback-container {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .ideas-feedback-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #E0E0E0;
            border-radius: 8px;
            font-size: 0.85rem;
            resize: vertical;
            min-height: 60px;
            font-family: inherit;
        }
        
        .ideas-feedback-input:focus {
            outline: none;
            border-color: #F53151;
        }
        
        .regenerate-ideas-btn {
            padding: 0.5rem 1rem;
            background: linear-gradient(to right, #F53151, #F742BD);
            color: white;
            border: none;
            border-radius: 24px;
            font-weight: 600;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
            align-self: flex-end;
        }
        
        .regenerate-ideas-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .regenerate-ideas-btn:active {
            transform: translateY(0);
        }
        
        .regenerate-ideas-btn.loading {
            opacity: 0.7;
            cursor: not-allowed;
        }
        
        .ideas-loading {
            display: none;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            font-size: 0.85rem;
            color: #666;
        }
        
        .ideas-loading.active {
            display: flex;
        }
        
        .ideas-loading-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(245, 49, 81, 0.3);
            border-radius: 50%;
            border-top-color: #F53151;
            animation: spin 1s linear infinite;
            margin-right: 0.5rem;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .creator-details {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            max-width: 500px;
            background-color: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            padding: 1.5rem;
            z-index: 100;
            display: none;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .creator-details-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 99;
            display: none;
        }
        
        .creator-details-overlay.active {
            display: block;
        }
        
        .creator-details.active {
            display: block;
        }
        
        .creator-details-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: #26201F;
        }
        
        .creator-details-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .creator-details-img {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .creator-details-name {
            font-size: 1.2rem;
            font-weight: 700;
            color: #26201F;
        }
        
        .creator-details-grade {
            font-size: 0.9rem;
            color: #26201F;
            margin-top: 0.25rem;
        }
        
        .creator-details-section {
            margin-bottom: 1.5rem;
        }
        
        .creator-details-section-title {
            font-size: 0.9rem;
            font-weight: 700;
            color: #26201F;
            margin-bottom: 0.5rem;
        }
        
        .creator-details-section-content {
            font-size: 0.9rem;
            color: #26201F;
        }
        
        .creator-details-ideas {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }
        
        .creator-details-idea-item {
            margin-bottom: 0.75rem;
            padding-left: 1.5rem;
            position: relative;
            transition: all 0.2s ease;
            padding-right: 1rem;
            border-radius: 4px;
        }
        
        .creator-details-idea-item:hover {
            background: linear-gradient(to right, rgba(245, 49, 81, 0.1), rgba(247, 66, 189, 0.1));
            padding: 0.5rem 1.5rem 0.5rem 1.5rem;
        }
        
        .creator-details-idea-item::before {
            content: "";
            position: absolute;
            left: 0;
            top: 0.5rem;
            width: 6px;
            height: 6px;
            background: linear-gradient(to right, #F53151, #F742BD);
            border-radius: 50%;
        }
        
        .creator-details-idea-item:hover .storyboard-idea-btn {
            opacity: 1;
            right: -10px;
        }
        
        .storyboard-idea-btn {
            position: absolute;
            right: -20px;
            top: 100%;
            transform: translateY(-50%);
            background: linear-gradient(to right, #F53151, #F742BD);
            color: white;
            border: none;
            border-radius: 16px;
            padding: 0.4rem 0.8rem;
            font-size: 0.7rem;
            font-weight: 600;
            cursor: pointer;
            opacity: 0;
            transition: all 0.2s ease;
            white-space: nowrap;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .creator-card-idea-item:hover .storyboard-idea-btn {
            opacity: 1;
            right: -20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="nav-placeholder"></div>
        <main class="content">
            <div class="search-container">
                <div class="search-input-container">
                    <div class="search-box">
                        <input type="text" placeholder="Enter your concept or brief" class="brand-input" data-translation-key="match-placeholder">
                        <div class="search-icons">
                            <img src="/icons/add.svg" alt="Add Files" class="plus-icon-svg" onclick="document.getElementById('fileInput').click()">
                        </div>
                        <input type="file" id="fileInput" class="file-input" multiple onchange="handleFileSelect(event)">
                    </div>
                </div>
                
                <div class="match-type-container">
                    <div class="match-type-selector">
                        <div class="match-type-slider position-1"></div>
                        <div class="match-type-option active" data-position="1" data-translation-key="match-type-expected">Expected</div>
                        <div class="match-type-option" data-position="2" data-translation-key="match-type-balanced">Balanced</div>
                        <div class="match-type-option" data-position="3" data-translation-key="match-type-unexpected">Unexpected</div>
                    </div>
                    <button class="get-dna-btn" onclick="getMatch()" data-translation-key="match-get-match-button">GET MATCH</button>
                </div>
            </div>
            <div class="file-list" id="fileList"></div>
            
            <div class="loading-container">
                <div class="loading-spinner"></div>
                <div class="loading-text">generating...</div>
            </div>
            
            <!-- Creator cards display -->
            <div class="creators-container" id="creatorsContainer">
                <!-- Creator cards will be added here dynamically -->
            </div>
            
            <!-- Creator details overlay -->
            <div class="creator-details-overlay" id="creatorDetailsOverlay"></div>
            
            <!-- Creator details popup -->
            <div class="creator-details" id="creatorDetails">
                <button class="creator-details-close" onclick="closeCreatorDetails()">×</button>
                <div class="creator-details-content">
                    <!-- Creator details will be populated here -->
                </div>
            </div>
            
            <div class="match-results" style="max-width: 600px; width: 100%; margin: 3rem auto;">
                <!-- Results will be inserted here -->
            </div>
        </main>
    </div>

    <script>
        let selectedFiles = new Set();
        // Store brand options for reference
        let brandOptions = new Map();
        // Store the current match type
        let currentMatchType = "expected";
        // Store the matches data
        let matchesData = [];

        document.addEventListener('DOMContentLoaded', async () => {
            await translateUI(); // Initial translation
            initializeMatchTypeSelector(); // Initialize the match type selector
            
            // Add event listener to the overlay to close details when clicked
            document.getElementById('creatorDetailsOverlay').addEventListener('click', closeCreatorDetails);
            
            // Add event listener for language changes to update placeholders
            document.getElementById('languageSelect').addEventListener('change', () => {
                // Update placeholders for textareas after language change
                setTimeout(() => {
                    const textareas = document.querySelectorAll('textarea[data-translation-key]');
                    textareas.forEach(textarea => {
                        const key = textarea.dataset.translationKey;
                        const currentLanguage = getClientLanguage() || 'english';
                        if (translations[key] && translations[key][currentLanguage]) {
                            textarea.setAttribute('placeholder', translations[key][currentLanguage]);
                        }
                    });
                }, 100); // Small delay to ensure translateUI has completed
            });
        });
        
        // Initialize the match type selector
        function initializeMatchTypeSelector() {
            const matchTypeOptions = document.querySelectorAll('.match-type-option');
            const matchTypeSlider = document.querySelector('.match-type-slider');
            
            matchTypeOptions.forEach(option => {
                option.addEventListener('click', () => {
                    // Remove active class from all options
                    matchTypeOptions.forEach(opt => opt.classList.remove('active'));
                    
                    // Add active class to clicked option
                    option.classList.add('active');
                    
                    // Move the slider
                    const position = option.dataset.position;
                    matchTypeSlider.className = `match-type-slider position-${position}`;
                    
                    // Set the current match type
                    const matchTypes = ["expected", "balanced", "unexpected"];
                    currentMatchType = matchTypes[position - 1];
                    console.log(`Match type set to: ${currentMatchType}`);
                });
            });
            
            // Calculate and set exact slider positions
            function adjustSliderPositions() {
                const selector = document.querySelector('.match-type-selector');
                if (!selector) return;
                
                const optionWidth = selector.offsetWidth / 3;
                const sliderWidth = optionWidth - 6; // Account for padding
                
                const slider = document.querySelector('.match-type-slider');
                if (slider) {
                    slider.style.width = `${sliderWidth}px`;
                    
                    // Update the CSS for position classes
                    const style = document.createElement('style');
                    style.textContent = `
                        .match-type-slider.position-1 { transform: translateX(0); }
                        .match-type-slider.position-2 { transform: translateX(${optionWidth}px); }
                        .match-type-slider.position-3 { transform: translateX(${optionWidth * 2}px); }
                    `;
                    document.head.appendChild(style);
                }
            }
            
            // Run on load and on window resize
            adjustSliderPositions();
            window.addEventListener('resize', adjustSliderPositions);
        }
        
        function handleFileSelect(event) {
            const files = event.target.files;
            const fileList = document.getElementById('fileList');
            
            for (const file of files) {
                if (!selectedFiles.has(file.name)) {
                    selectedFiles.add(file.name);
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    fileItem.innerHTML = `
                        <span>${file.name}</span>
                        <span class="remove-file" onclick="removeFile('${file.name}')">×</span>
                    `;
                    fileList.appendChild(fileItem);
                }
            }
        }

        function removeFile(fileName) {
            selectedFiles.delete(fileName);
            const fileList = document.getElementById('fileList');
            const fileItems = fileList.getElementsByClassName('file-item');
            for (const item of Array.from(fileItems)) {
                if (item.firstElementChild.textContent === fileName) {
                    fileList.removeChild(item);
                    break;
                }
            }
        }
        
        // Placeholder for the getMatch function - will be implemented later
        async function getMatch() {
            const loadingContainer = document.querySelector('.loading-container');
            const resultsContainer = document.querySelector('.match-results');
            const fileInput = document.getElementById('fileInput');
            const creatorsContainer = document.getElementById('creatorsContainer');
            
            let brief = document.querySelector('.brand-input').value.trim();
            const currentDNA = getClientDNA();
            
            if (!currentDNA) {
                alert('Please select a brand DNA from the left navigation menu.');
                return;
            }
            
            if (!brief && selectedFiles.size === 0) {
                alert('Please enter a brief or upload a document.');
                return;
            }
            
            try {
                // Show loading indicator
                loadingContainer.style.display = 'flex';
                resultsContainer.innerHTML = '';
                creatorsContainer.innerHTML = '';
                
                // If there's an uploaded PDF, add a note about it to the brief
                if (selectedFiles.size > 0) {
                    brief = `The brand has attached a brief for their concept:\n\n${brief}`;
                }
                
                // Check if a creator is selected in the Match setting
                const selectedCreator = sessionStorage.getItem('currentMatch');
                if (selectedCreator && selectedCreator.trim() !== '') {
                    console.log('Match - Selected creator:', selectedCreator);
                    brief += `\n\nIMPORTANT: One of the matches MUST BE ${selectedCreator}.`;
                }
                
                // Add match type to the brief with specific instructions for each type
                brief += `\n\nMatch type: ${currentMatchType}.`;
                
                // Add specific prompt modifications based on match type
                if (currentMatchType === "balanced") {
                    brief += `\n\nIMPORTANT INSTRUCTION: For this "balanced" match, I want you to be more creative than you would typically be. While staying true to the core of the brand DNA, look for creators who bring a fresh perspective or slightly different audience. Find creators who maintain the essence of the brand values but add some diversity in style, audience, or approach. These matches should feel like a natural extension of the brand that opens new creative possibilities.`;
                } else if (currentMatchType === "unexpected") {
                    brief += `\n\nIMPORTANT INSTRUCTION: For this "unexpected" match, I want you to make bold, surprising connections. Look for creators who might seem unconventional for this brand at first glance but could create truly innovative collaborations. These creators should still align with the core brand values at a fundamental level, but they might express those values in completely different ways or reach entirely different audiences. These matches should feel unexpected yet somehow make perfect sense when explained. Push the boundaries of conventional brand partnerships while ensuring there's still a meaningful connection.`;
                }
                // For "expected" type, no additional instructions needed
                
                const clientLanguage = getClientLanguage();
                
                // Add language-specific instructions if Spanish is selected
                if (clientLanguage === 'spanish') {
                    brief += `\n\nIMPORTANT: Please generate all content ideas and explanations in Spanish.`;
                }
                
                // Create FormData and append files
                const formData = new FormData();
                formData.append('brief', brief);
                formData.append('brandDNA', JSON.stringify(currentDNA));
                formData.append('language', clientLanguage);
                formData.append('matchType', currentMatchType);
                
                // Add selected files
                const fileList = document.getElementById('fileList');
                const fileItems = fileList.getElementsByClassName('file-item');
                for (const item of Array.from(fileItems)) {
                    const fileName = item.firstElementChild.textContent;
                    const fileObj = Array.from(fileInput.files).find(f => f.name === fileName);
                    if (fileObj) {
                        formData.append('file', fileObj);
                    }
                }
                
                const response = await fetch(`${window.API_BASE_URL}/getMatch`, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'Failed to get matches');
                }
                
                // Store the matches data in the global variable
                if (!data.matches || !Array.isArray(data.matches) || data.matches.length === 0) {
                    throw new Error('No matches found or invalid match data received');
                }
                
                matchesData = data.matches;
                console.log('Received match data:', matchesData);
                
                // Pre-fetch creator DNAs to ensure we have them for display
                try {
                    const creatorResponse = await fetch(`${window.API_BASE_URL}/getCreatorDNAs`);
                    const creatorDNAs = await creatorResponse.json();
                    console.log('Fetched creator DNAs for display');
                    
                    // Enhance matchesData with additional creator info if available
                    matchesData.forEach(match => {
                        const creatorData = creatorDNAs[match.creatorName];
                        if (creatorData) {
                            // Add any useful creator data that isn't already in the match
                            match.channelThumbnail = creatorData.channelThumbnail;
                            match.channelUrl = creatorData.channelUrl;
                            match.subscriberCount = creatorData.subscriberCount;
                            match.averageViews = creatorData.averageViews;
                        }
                    });
                } catch (error) {
                    console.error('Error pre-fetching creator DNAs:', error);
                    // Continue anyway, we'll handle missing data in the display functions
                }
                
                // Display creators in cards
                displayCreatorsInCards(matchesData);
                
                // Clear file list after successful submission
                fileList.innerHTML = '';
                selectedFiles.clear();
                
            } catch (error) {
                console.error('Error:', error);
                resultsContainer.innerHTML = `<p>Error: ${error.message}</p>`;
            } finally {
                loadingContainer.style.display = 'none';
            }
        }
        
        // Function to display creators in cards
        async function displayCreatorsInCards(creators) {
            const container = document.getElementById('creatorsContainer');
            container.innerHTML = '';
            
            // Limit to 8 creators for now
            const displayCreators = creators.slice(0, 8);
            
            displayCreators.forEach((creator, index) => {
                // Format subscriber count
                let subscriberCount = 'N/A';
                if (creator.subscriberCount) {
                    subscriberCount = formatSubscriberCount(creator.subscriberCount);
                }
                
                // Get the current language for translations
                const currentLanguage = getClientLanguage() || 'english';
                
                // Get translated text for storyboard button
                const storyboardBtnText = translations['match-storyboard-idea'] && 
                                         translations['match-storyboard-idea'][currentLanguage] ? 
                                         translations['match-storyboard-idea'][currentLanguage] : 
                                         'STORYBOARD IDEA';
                
                // Parse content ideas for the expanded view
                let ideasHtml = '';
                if (creator.contentIdeas) {
                    // Make sure contentIdeas is a string before trying to split it
                    const contentIdeasStr = typeof creator.contentIdeas === 'string' 
                        ? creator.contentIdeas 
                        : Array.isArray(creator.contentIdeas) 
                            ? creator.contentIdeas.join('. ') 
                            : JSON.stringify(creator.contentIdeas);
                    
                    let ideas = [];
                    
                    try {
                        // Try to split by periods followed by commas first
                        ideas = contentIdeasStr.split('.,').map(idea => idea.trim().replace(/\.$/, ''));
                        
                        // If we only got one item, try splitting by periods
                        if (ideas.length === 1 && contentIdeasStr.includes('.')) {
                            ideas = contentIdeasStr.split('.').filter(idea => idea.trim().length > 0).map(idea => idea.trim());
                        }
                        
                        // If still only one or empty, just use the whole string
                        if (ideas.length <= 1) {
                            ideas = [contentIdeasStr];
                        }
                    } catch (error) {
                        console.error('Error parsing content ideas:', error);
                        ideas = [contentIdeasStr];
                    }
                    
                    ideasHtml = `
                        <ul class="creator-card-ideas">
                            ${ideas.map(idea => `
                                <li class="creator-card-idea-item">${idea}
                                    <button class="storyboard-idea-btn" onclick="openStoryboardWithIdea('${creator.creatorName}', this.parentElement.textContent)" data-translation-key="match-storyboard-idea">${storyboardBtnText}</button>
                                </li>
                            `).join('')}
                        </ul>
                    `;
                } else {
                    ideasHtml = '<p>No content ideas available.</p>';
                }
                
                const card = document.createElement('div');
                card.className = 'creator-card';
                card.dataset.creatorIndex = index;
                
                card.innerHTML = `
                    <div class="creator-card-grade">${creator.matchGrade || 'N/A'}</div>
                    <div class="creator-card-header">
                        <img 
                            src="${creator.channelThumbnail ? `/proxy-image?url=${encodeURIComponent(creator.channelThumbnail)}` : '/icons/person.svg'}" 
                            alt="${creator.creatorName}" 
                            class="creator-card-img"
                            crossorigin="anonymous"
                        >
                        <div class="creator-card-info">
                            <div class="creator-card-name">${creator.creatorName}</div>
                            <div class="creator-card-subscribers">${subscriberCount} subscribers</div>
                        </div>
                    </div>
                    <button class="creator-card-toggle" data-translation-key="match-view-details">View Details</button>
                    <div class="creator-card-content">
                        <div class="creator-card-section">
                            <div class="creator-card-section-title" data-translation-key="match-why-works">Why This Match Works</div>
                            <div class="creator-card-section-content">${creator.reasonForMatch || 'No information available.'}</div>
                        </div>
                        <div class="creator-card-section">
                            <div class="creator-card-section-title" data-translation-key="match-content-ideas">Content Ideas</div>
                            <div class="creator-card-ideas-container">
                                ${ideasHtml}
                                <div class="ideas-loading">
                                    <div class="ideas-loading-spinner"></div>
                                    <span data-translation-key="match-regenerating-ideas">Regenerating ideas...</span>
                                </div>
                                <div class="ideas-feedback-container">
                                    <textarea 
                                        class="ideas-feedback-input" 
                                        placeholder="Change these ideas..."
                                        data-translation-key="match-change-ideas"
                                    ></textarea>
                                    <button class="regenerate-ideas-btn" data-creator-index="${index}" data-translation-key="match-regenerate-ideas">REGENERATE IDEAS</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                container.appendChild(card);
                
                // Add click event to toggle button
                const toggleButton = card.querySelector('.creator-card-toggle');
                toggleButton.addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent card click event
                    
                    // Toggle the current card
                    card.classList.toggle('expanded');
                    
                    // Get the appropriate translation key based on expanded state
                    const translationKey = card.classList.contains('expanded') ? 'match-hide-details' : 'match-view-details';
                    
                    // Get the current language
                    const currentLanguage = getClientLanguage() || 'english';
                    
                    // Set the button text based on the translation
                    if (translations[translationKey] && translations[translationKey][currentLanguage]) {
                        toggleButton.textContent = translations[translationKey][currentLanguage];
                    } else {
                        // Fallback if translation not found
                        toggleButton.textContent = card.classList.contains('expanded') ? 'Hide Details' : 'View Details';
                    }
                });
                
                // Also add click event to the card header for easier toggling
                const cardHeader = card.querySelector('.creator-card-header');
                cardHeader.addEventListener('click', () => {
                    // Toggle the current card
                    card.classList.toggle('expanded');
                    
                    // Get the appropriate translation key based on expanded state
                    const translationKey = card.classList.contains('expanded') ? 'match-hide-details' : 'match-view-details';
                    
                    // Get the current language
                    const currentLanguage = getClientLanguage() || 'english';
                    
                    // Set the button text based on the translation
                    if (translations[translationKey] && translations[translationKey][currentLanguage]) {
                        toggleButton.textContent = translations[translationKey][currentLanguage];
                    } else {
                        // Fallback if translation not found
                        toggleButton.textContent = card.classList.contains('expanded') ? 'Hide Details' : 'View Details';
                    }
                });
                cardHeader.style.cursor = 'pointer';
                
                // Add event listener for regenerate ideas button
                const regenerateBtn = card.querySelector('.regenerate-ideas-btn');
                regenerateBtn.addEventListener('click', (e) => {
                    regenerateContentIdeas(e.target);
                });
            });
        }
        
        // Function to regenerate content ideas
        async function regenerateContentIdeas(button) {
            const creatorIndex = button.dataset.creatorIndex;
            const creator = matchesData[creatorIndex];
            
            if (!creator) {
                console.error('Creator data not found for index:', creatorIndex);
                return;
            }
            
            const card = button.closest('.creator-card');
            const feedbackInput = card.querySelector('.ideas-feedback-input');
            const feedback = feedbackInput.value.trim();
            
            if (!feedback) {
                alert('Please enter feedback to improve the ideas.');
                return;
            }
            
            // Get the current ideas
            let currentIdeas = [];
            if (creator.contentIdeas) {
                const contentIdeasStr = typeof creator.contentIdeas === 'string' 
                    ? creator.contentIdeas 
                    : Array.isArray(creator.contentIdeas) 
                        ? creator.contentIdeas.join('. ') 
                        : JSON.stringify(creator.contentIdeas);
                
                try {
                    // Try to split by periods followed by commas first
                    currentIdeas = contentIdeasStr.split('.,').map(idea => idea.trim().replace(/\.$/, ''));
                    
                    // If we only got one item, try splitting by periods
                    if (currentIdeas.length === 1 && contentIdeasStr.includes('.')) {
                        currentIdeas = contentIdeasStr.split('.').filter(idea => idea.trim().length > 0).map(idea => idea.trim());
                    }
                    
                    // If still only one or empty, just use the whole string
                    if (currentIdeas.length <= 1) {
                        currentIdeas = [contentIdeasStr];
                    }
                } catch (error) {
                    console.error('Error parsing content ideas:', error);
                    currentIdeas = [contentIdeasStr];
                }
            }
            
            // Show loading state
            button.disabled = true;
            button.classList.add('loading');
            const ideasContainer = card.querySelector('.creator-card-ideas-container');
            const ideasList = card.querySelector('.creator-card-ideas');
            const loadingIndicator = card.querySelector('.ideas-loading');
            
            if (ideasList) {
                ideasList.style.display = 'none';
            }
            loadingIndicator.classList.add('active');
            
            try {
                const currentDNA = getClientDNA();
                if (!currentDNA) {
                    throw new Error('No brand DNA selected');
                }
                
                // Get the brief from the input
                const brief = document.querySelector('.brand-input').value.trim();
                
                // Get the current language
                const clientLanguage = getClientLanguage() || 'english';
                
                // Get translated text for storyboard button
                const storyboardBtnText = translations['match-storyboard-idea'] && 
                                         translations['match-storyboard-idea'][clientLanguage] ? 
                                         translations['match-storyboard-idea'][clientLanguage] : 
                                         'STORYBOARD IDEA';
                
                // Prepare feedback with language instruction if Spanish is selected
                let enhancedFeedback = feedback;
                if (clientLanguage === 'spanish') {
                    enhancedFeedback += "\n\nIMPORTANT: Please generate these content ideas in Spanish.";
                }
                
                // Prepare the data for the API call
                const requestData = {
                    brandDNA: currentDNA,
                    creatorDNA: creator,
                    currentIdeas: currentIdeas,
                    feedback: enhancedFeedback,
                    brief: brief,
                    language: clientLanguage
                };
                
                // Make the API call
                const response = await fetch(`${window.API_BASE_URL}/regenerateContentIdeas`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'Failed to regenerate ideas');
                }
                
                // Update the ideas in the matchesData
                if (data.contentIdeas) {
                    matchesData[creatorIndex].contentIdeas = data.contentIdeas;
                    
                    // Get the current language for translations
                    const currentLanguage = getClientLanguage() || 'english';
                    
                    // Get translated text for storyboard button
                    const storyboardBtnText = translations['match-storyboard-idea'] && 
                                             translations['match-storyboard-idea'][currentLanguage] ? 
                                             translations['match-storyboard-idea'][currentLanguage] : 
                                             'STORYBOARD IDEA';
                    
                    // Update the display
                    let newIdeasHtml = '';
                    if (Array.isArray(data.contentIdeas)) {
                        newIdeasHtml = `
                            <ul class="creator-card-ideas">
                                ${data.contentIdeas.map(idea => `
                                    <li class="creator-card-idea-item">${idea}
                                        <button class="storyboard-idea-btn" onclick="openStoryboardWithIdea('${creator.creatorName}', this.parentElement.textContent)" data-translation-key="match-storyboard-idea">${storyboardBtnText}</button>
                                    </li>
                                `).join('')}
                            </ul>
                        `;
                    } else {
                        // Handle string format
                        const ideas = data.contentIdeas.split('.').filter(idea => idea.trim().length > 0).map(idea => idea.trim());
                        newIdeasHtml = `
                            <ul class="creator-card-ideas">
                                ${ideas.map(idea => `
                                    <li class="creator-card-idea-item">${idea}
                                        <button class="storyboard-idea-btn" onclick="openStoryboardWithIdea('${creator.creatorName}', this.parentElement.textContent)" data-translation-key="match-storyboard-idea">${storyboardBtnText}</button>
                                    </li>
                                `).join('')}
                            </ul>
                        `;
                    }
                    
                    // Replace the old ideas list with the new one
                    if (ideasList) {
                        ideasList.remove();
                    }
                    ideasContainer.insertAdjacentHTML('afterbegin', newIdeasHtml);
                    
                    // Clear the feedback input
                    feedbackInput.value = '';
                }
                
            } catch (error) {
                console.error('Error regenerating ideas:', error);
                alert(`Error: ${error.message}`);
            } finally {
                // Hide loading state
                button.disabled = false;
                button.classList.remove('loading');
                loadingIndicator.classList.remove('active');
                
                // Show the ideas list again
                const newIdeasList = card.querySelector('.creator-card-ideas');
                if (newIdeasList) {
                    newIdeasList.style.display = 'block';
                }
            }
        }
        
        // Function to show creator details
        function showCreatorDetails(creatorIndex) {
            console.log('Showing creator details for index:', creatorIndex);
            
            const creator = matchesData[creatorIndex];
            if (!creator) {
                console.error('Creator data not found for index:', creatorIndex);
                return;
            }
            
            console.log('Creator data:', creator);
            
            const detailsContainer = document.getElementById('creatorDetails');
            const detailsOverlay = document.getElementById('creatorDetailsOverlay');
            const contentContainer = detailsContainer.querySelector('.creator-details-content');
            
            // Format subscriber count
            let subscriberCount = 'N/A';
            if (creator.subscriberCount) {
                subscriberCount = formatSubscriberCount(creator.subscriberCount);
            }
            
            // Format average views
            let averageViews = '';
            if (creator.averageViews) {
                averageViews = `<div>${formatSubscriberCount(creator.averageViews)} avg. views/video</div>`;
            }
            
            // Channel URL
            const channelUrl = creator.channelUrl || '#';
            
            // Parse content ideas - handle different formats
            let ideasHtml = '';
            if (creator.contentIdeas) {
                // Make sure contentIdeas is a string before trying to split it
                const contentIdeasStr = typeof creator.contentIdeas === 'string' 
                    ? creator.contentIdeas 
                    : Array.isArray(creator.contentIdeas) 
                        ? creator.contentIdeas.join('. ') 
                        : JSON.stringify(creator.contentIdeas);
                
                // Get the current language for translations
                const currentLanguage = getClientLanguage() || 'english';
                
                // Get translated text for storyboard button
                const storyboardBtnText = translations['match-storyboard-idea'] && 
                                         translations['match-storyboard-idea'][currentLanguage] ? 
                                         translations['match-storyboard-idea'][currentLanguage] : 
                                         'STORYBOARD IDEA';
                
                let ideas = [];
                
                try {
                    // Try to split by periods followed by commas first
                    ideas = contentIdeasStr.split('.,').map(idea => idea.trim().replace(/\.$/, ''));
                    
                    // If we only got one item, try splitting by periods
                    if (ideas.length === 1 && contentIdeasStr.includes('.')) {
                        ideas = contentIdeasStr.split('.').filter(idea => idea.trim().length > 0).map(idea => idea.trim());
                    }
                    
                    // If still only one or empty, just use the whole string
                    if (ideas.length <= 1) {
                        ideas = [contentIdeasStr];
                    }
                } catch (error) {
                    console.error('Error parsing content ideas:', error);
                    ideas = [contentIdeasStr];
                }
                
                ideasHtml = `
                    <ul class="creator-details-ideas">
                        ${ideas.map(idea => `
                            <li class="creator-details-idea-item">${idea}
                                <button class="storyboard-idea-btn" onclick="openStoryboardWithIdea('${creator.creatorName}', this.parentElement.textContent)" data-translation-key="match-storyboard-idea">${storyboardBtnText}</button>
                            </li>
                        `).join('')}
                    </ul>
                `;
            } else {
                ideasHtml = '<p>No content ideas available.</p>';
            }
            
            // Build HTML
            contentContainer.innerHTML = `
                <div class="creator-details-header">
                    <img 
                        src="${creator.channelThumbnail ? `/proxy-image?url=${encodeURIComponent(creator.channelThumbnail)}` : '/icons/person.svg'}" 
                        alt="${creator.creatorName}" 
                        class="creator-details-img"
                        crossorigin="anonymous"
                    >
                    <div>
                        <a href="${channelUrl}" target="_blank" class="creator-details-name" style="text-decoration: none; color: inherit;">
                            ${creator.creatorName}
                            <span style="margin-left: 4px; font-size: 0.9em;">↗</span>
                        </a>
                        <div class="creator-details-grade">Match Grade: ${creator.matchGrade || 'N/A'}</div>
                        <div>${subscriberCount} subscribers</div>
                        ${averageViews}
                    </div>
                </div>
                
                <div class="creator-details-section">
                    <div class="creator-details-section-title" data-translation-key="match-why-works">Why This Match Works</div>
                    <div class="creator-details-section-content">${creator.reasonForMatch || 'No information available.'}</div>
                </div>
                
                <div class="creator-details-section">
                    <div class="creator-details-section-title" data-translation-key="match-content-ideas">Content Ideas</div>
                    ${ideasHtml}
                </div>
            `;
            
            // Show the details container and overlay
            detailsContainer.classList.add('active');
            detailsOverlay.classList.add('active');
            
            // Ensure the popup is visible and in front of other elements
            detailsContainer.style.zIndex = '100';
            
            console.log('Creator details popup activated');
        }
        
        // Function to close creator details
        function closeCreatorDetails() {
            const detailsContainer = document.getElementById('creatorDetails');
            const detailsOverlay = document.getElementById('creatorDetailsOverlay');
            detailsContainer.classList.remove('active');
            detailsOverlay.classList.remove('active');
        }
        
        // Helper function to format subscriber count
        function formatSubscriberCount(count) {
            if (count >= 1000000) {
                return (count / 1000000).toFixed(1) + 'M';
            } else if (count >= 1000) {
                return (count / 1000).toFixed(1) + 'K';
            }
            return count;
        }
        
        // Function to open storyboard with the selected idea
        function openStoryboardWithIdea(creatorName, ideaText) {
            // Clean up the idea text by removing the button text
            const cleanIdea = ideaText.replace('STORYBOARD IDEA', '').trim();
            
            // Get the campaign brief from the input
            const campaignBrief = document.querySelector('.brand-input').value.trim();
            
            // Encode parameters for URL
            const params = new URLSearchParams();
            params.set('concept', cleanIdea);
            params.set('integration', 'full_integration'); // Default to full integration
            params.set('creator', creatorName);
            params.set('campaignBrief', campaignBrief); // Add campaign brief
            
            // Navigate to storyboard-v2.html with the parameters in a new tab
            window.open(`storyboard-v2.html?${params.toString()}`, '_blank');
        }
    </script>
</body>
</html> 