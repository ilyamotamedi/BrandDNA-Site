<!DOCTYPE html>
<html lang="en">
<head>
    <script src="config.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brand DNA - Storyboarding</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Unbounded:wght@200..900&display=swap">
    <link rel="stylesheet" href="styles.css">
    <script src="nav-template.js"></script>
    <style>
.storyboard-results-container {
    width: 100%;
    max-width: calc(100vw - 350px);
    margin-top: 1rem;
    height: calc(100vh - 280px);
    overflow-y: auto;
    position: relative;
    pointer-events: auto; /* Ensure scrolling works */
}

.storyboard-results {
    display: flex;
    gap: 1rem;
    padding: 1rem;
    position: relative;
    transition: transform 0.5s ease;
    min-height: min-content;
    pointer-events: auto; /* Ensure scrolling works */
}


.storyboard-card {
    background: white;
    border-radius: 16px;
    padding: 0 0 2rem 0;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    border: 1px solid;
    width: 500px;
    flex: 0 0 auto;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    max-height: 100%; /* Limit card height to container */
    pointer-events: auto;
}

        .storyboard-image {
    width: 100%;
    height: auto;
    border-radius: 0; /* Remove border radius since it's flush with card */
    display: block; /* Remove any potential spacing */
}

        .storyboard-image-loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 300px;
            background-color: #f6f6f6;
            border-radius: 8px;
        }

        .brand-card-title {
    margin-top: 0; /* Reset top margin */
    margin-bottom: 1rem;
    padding: 0 2rem;
}


        .brand-card-body {
    flex-grow: 1;
    overflow-y: auto;
    margin-bottom: 0;
    padding: 0 2rem;
    max-height: 200px; /* Limit description height */
}
        .creator-select-container {
            display: flex;
            gap: 1rem;
            margin-bottom: 0rem;
            margin-top: 1rem;
            align-items: center; /* Vertically align items */
        }

        .creator-select-box {
            flex-grow: 1;
            position: relative;
            border: 1px solid #ddd;
            border-radius: 24px;
            background: white;
            overflow: visible;
            display: flex;
            align-items: center;
        }

        .creator-input {
            width: 100%;
            padding: 0.8rem 1.5rem;
            font-family: 'Unbounded', sans-serif;
            border: none;
            outline: none;
            background: transparent;
        }

        .creator-dropdown-arrow {
            width: 28px;
            height: 28px;
            cursor: pointer;
            transition: transform 0.2s ease;
            padding: 0px;
            opacity: 0.7;
            margin-right: 1rem;
        }

        .creator-dropdown-arrow:hover {
            opacity: 1.0;
        }

        .creator-dropdown-menu {
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            width: 100%;
            max-height: 16.5rem;
            overflow-y: auto;
            background: white;
            border: 1px solid #ddd;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            z-index: 1000;
            display: none;
        }

        .creator-dropdown-menu.active {
            display: block;
        }

        .creator-dropdown-item {
            padding: 1rem 1.5rem;
            font-family: 'Unbounded', sans-serif;
            font-size: 0.9rem;
            color: #26201F;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            height: 3.2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .image-wrapper {
    position: relative;
    width: 100%;
    margin-bottom: 0; /* Remove margin */
}

.storyboard-image {
    width: 100%;
    height: auto;
    border-radius: 0; /* Remove border radius since it's flush with card */
    display: block; /* Remove any potential spacing */
}

.download-button {
    position: absolute;
    top: 12px;
    right: 12px;
    width: 36px;
    height: 36px;
    border-radius: 8px;
    background-color: rgba(0, 0, 0, 0.2);
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background-color 0.2s ease;
    padding: 6px;
    z-index: 1; /* Ensure button stays above image */
}

.download-button:hover {
    background-color: rgba(0, 0, 0, 0.3);
}

.download-button svg {
    width: 20px;
    height: 20px;
}

/* Scene number styling */
.scene-number {
    padding: 0 2rem;
    font-size: 0.8rem;
    color: #666;
    margin-bottom: 0.5rem; /* Add space between scene number and title */
    margin-top: 1rem;
}

/* Prompt section styling */
.prompt-section {
    padding: 0 2rem;
    margin-top: 1rem;
}

.prompt-button {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    background: none;
    border: none;
    color: #666;
    cursor: pointer;
    font-family: 'Unbounded', sans-serif;
    font-size: 0.8rem;
    padding: 0.5rem 0;
}

.prompt-button:hover {
    color: #000;
}

.chevron-icon {
    transition: transform 0.2s ease;
}

.prompt-button.expanded .chevron-icon {
    transform: rotate(180deg);
}

.prompt-content {
    font-size: 0.85rem;
    color: #666;
    background: #f8f8f8;
    padding: 1rem;
    border-radius: 8px;
    margin-top: 0.5rem;
    white-space: pre-wrap;
}

.navigation-container {
    width: 100%;
    max-width: 600px; /* Match other containers */
    padding: 0 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    z-index: 100;
}

.nav-arrow {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: white;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    color: #ffffff;
    background: radial-gradient(circle at center, #F53151 0%, #F742BD 100%);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transition: all 0.2s ease;
    pointer-events: auto;
    opacity: 1.0;
    padding-bottom: 2px;
}

.nav-arrow:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    background: #ffffff;
    color: #929292;
}

.nav-arrow:not(:disabled):hover {
    opacity: 1;
    transform: scale(1.1);
}

.storyboard-results {
    position: relative;
    transition: transform 0.5s ease;
}

.search-row {
    display: flex;
    gap: 1rem;
    max-width: 550px;
    width: 100%;
}

.integration-select {
    width: 180px;
    padding: 0.8rem 1.5rem;
    font-family: 'Unbounded', sans-serif;
    border: 1px solid #ddd;
    border-radius: 24px;
    background: white;
    outline: none;
    cursor: pointer;
    font-size: 0.9rem;
    appearance: none;
    background-image: url('/icons/drop_down.svg');
    background-repeat: no-repeat;
    background-position: calc(100% - 1rem) center;
    background-size: 28px;
}

/* Style for the placeholder option */
.integration-select option[value=""] {
    color: #999;
}

/* Style for the select when showing placeholder */
.integration-select.placeholder {
    color: #999;
}

/* Style for actual options and selected state */
.integration-select:not(.placeholder) {
    color: #26201F;
}
    </style>
</head>
<body>
    <div class="container">
        <div id="nav-placeholder"></div>
        <main class="content">
            <div class="search-row">
                <div class="search-box" style="flex: 1;">
                    <input type="text" placeholder="Describe your video concept..." class="brand-input" id="videoConcept" data-translation-key="storyboard-concept-placeholder">
                </div>
                <select class="integration-select placeholder" id="integrationType">
                    <option value="" disabled selected data-translation-key="storyboard-integration-placeholder">Integration</option>
                    <option value="brand_mention" data-translation-key="integration-mention">Mention</option>
                    <option value="mid_video" data-translation-key="integration-adbreak">Ad Break</option>
                    <option value="full_integration" data-translation-key="integration-full">Full Integration</option>
                </select>
            </div>
            <div class="creator-select-container">
                <div class="creator-select-box" style="max-width: 600px;">
                    <input type="text" placeholder="Select a creator..." class="creator-input" id="creatorInput" readonly data-translation-key="storyboard-creator-placeholder">
                    <img src="/icons/drop_down.svg" alt="Dropdown" class="creator-dropdown-arrow" id="creatorDropdownArrow">
                    <div class="creator-dropdown-menu" id="creatorDropdown"></div>
                </div>
                <button class="get-dna-btn" onclick="generateStoryboard()" style="flex-shrink: 0;" data-translation-key="storyboard-generate-button">GENERATE STORYBOARD</button>
            </div>
            <div class="navigation-container" style="margin: 2rem 0;">
                <button class="nav-arrow prev" onclick="navigateStoryboard('prev')" disabled>←</button>
                <button class="nav-arrow next" onclick="navigateStoryboard('next')" disabled>→</button>
            </div>
            <div class="loading-container">
                <div class="loading-spinner"></div>
                <div class="loading-text">generating...</div>
            </div>
            <div class="storyboard-results-container">
                <div class="storyboard-results"></div>
            </div>
        </main>
    </div>

    <script>
let currentIndex = 0;
let totalCards = 0;

function updateNavigationButtons() {
    const prevButton = document.querySelector('.nav-arrow.prev');
    const nextButton = document.querySelector('.nav-arrow.next');
    
    prevButton.disabled = currentIndex === 0;
    // Fix the next button logic to disable at the correct point
    nextButton.disabled = currentIndex >= totalCards - 1;
}

function navigateStoryboard(direction) {
    const container = document.querySelector('.storyboard-results');
    const cardWidth = 500 + 16; // card width + gap
    
    if (direction === 'next' && currentIndex < totalCards - 1) {
        currentIndex++;
    } else if (direction === 'prev' && currentIndex > 0) {
        currentIndex--;
    }
    
    container.style.transform = `translateX(${-currentIndex * cardWidth}px)`;
    updateNavigationButtons();
}

// Keep only keyboard navigation
document.addEventListener('keydown', (e) => {
    if (e.key === 'ArrowLeft' && currentIndex > 0) {
        navigateStoryboard('prev');
    } else if (e.key === 'ArrowRight' && currentIndex < totalCards - 1) {
        navigateStoryboard('next');
    }
});

        let selectedCreatorDNA = null;

        async function generateStoryboard() {
    const videoConcept = document.getElementById('videoConcept').value.trim();
    const integrationType = document.getElementById('integrationType').value;
    const loadingContainer = document.querySelector('.loading-container');
    const resultsContainer = document.querySelector('.storyboard-results');
    const resultsContainerWrapper = document.querySelector('.storyboard-results-container');
    
    if (!videoConcept) {
        alert('Please enter a video concept');
        return;
    }

    if (!integrationType) {
        alert('Please select an integration type');
        return;
    }

    if (!selectedCreatorDNA) {
        alert('Please select a creator');
        return;
    }

    const currentBrandDNA = getClientDNA();
    if (!currentBrandDNA) {
        alert('Please select a brand DNA');
        return;
    }

    // Create an integration type description map
    const integrationDescriptions = {
        brand_mention: "A short (15-30 second) acknowledgement of the brand within the video, usually involving a brief description and call to action.",
        mid_video: "A distinct 30-60 second (or longer) promotional segment in the middle of the video, where the creator directly promotes the brand and its products.",
        full_integration: "The brand's product or service is seamlessly woven into the video's core content, acting as a central element of the story, tutorial, or challenge."
    };

    try {
        loadingContainer.style.display = 'flex';
        resultsContainer.innerHTML = '';

        const clientLanguage = getClientLanguage();
        console.log('Client language detected:', clientLanguage);
        
        const requestBody = {
            videoConcept: videoConcept,
            brandDNA: currentBrandDNA,
            creatorDNA: selectedCreatorDNA,
            integrationType: {
                type: integrationType,
                description: integrationDescriptions[integrationType]
            },
            language: clientLanguage
        };
        
        console.log('Sending storyboard request with language:', clientLanguage);

        const response = await fetch(`${window.API_BASE_URL}/generateStoryboard`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestBody)
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        const cleanJSON = data.replace(/```json\n|\n```/g, '').trim();
        const storyboard = JSON.parse(cleanJSON).storyboard;

        // Extract image prompts
        const imagePrompts = storyboard.map(act => act.image_prompt);
        
        console.log('Sending image generation request with language:', clientLanguage);

        // Generate images for all prompts
        const imageResponse = await fetch(`${window.API_BASE_URL}/generateStoryboardImages`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 
                imagePrompts,
                language: getClientLanguage()
            })
        });

        if (!imageResponse.ok) {
            throw new Error(`HTTP error! status: ${imageResponse.status}`);
        }

        const imageData = await imageResponse.json();

        loadingContainer.style.display = 'none';
        resultsContainer.innerHTML = '';

        // Create cards with both content and images
        // Create cards with both content and images
        storyboard.forEach((act, index) => {
            const card = document.createElement('div');
            card.className = 'storyboard-card';
            card.style.borderColor = currentBrandDNA.brandColors[0];

            // Add the generated image
            if (imageData.images[index]) {
                const imageWrapper = document.createElement('div');
                imageWrapper.className = 'image-wrapper';

                const img = document.createElement('img');
                img.src = `data:image/png;base64,${imageData.images[index]}`;
                img.className = 'storyboard-image';

                // Create download button
                const downloadButton = document.createElement('button');
                downloadButton.className = 'download-button';
                downloadButton.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="white">
                        <path d="M480-320 280-520l56-58 104 104v-326h80v326l104-104 56 58-200 200ZM240-160q-33 0-56.5-23.5T160-240v-120h80v120h480v-120h80v120q0 33-23.5 56.5T720-160H240Z"/>
                    </svg>
                `;

                downloadButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const link = document.createElement('a');
                    link.href = img.src;
                    link.download = `storyboard-scene-${index + 1}.png`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                });

                imageWrapper.appendChild(img);
                imageWrapper.appendChild(downloadButton);
                card.appendChild(imageWrapper);
            }

            // Create scene number
            const sceneNumber = document.createElement('div');
            sceneNumber.className = 'scene-number';
            const sceneKey = `scene-${index + 1}`; // Dynamic key: scene-1, scene-2, etc.
            sceneNumber.setAttribute('data-translation-key', sceneKey); // Add data-translation-key
            sceneNumber.textContent = `Scene ${index + 1}`;

            const title = document.createElement('h2');
            title.className = 'brand-card-title';
            title.textContent = act.act_title;

            const body = document.createElement('div');
            body.className = 'brand-card-body';
            body.textContent = act.act_description;

            // Create prompt reveal section
            const promptSection = document.createElement('div');
            promptSection.className = 'prompt-section';

            const promptButton = document.createElement('button');
            promptButton.className = 'prompt-button';
            promptButton.innerHTML = `
                <span data-translation-key="storyboard-show-prompt">Show Prompt</span>
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="chevron-icon">
                    <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
            `;

            const promptContent = document.createElement('div');
            promptContent.className = 'prompt-content';
            promptContent.textContent = act.image_prompt;
            promptContent.style.display = 'none';

            promptButton.addEventListener('click', () => {
                const isExpanded = promptContent.style.display !== 'none';
                promptContent.style.display = isExpanded ? 'none' : 'block';
                promptButton.classList.toggle('expanded');
            });

            promptSection.appendChild(promptButton);
            promptSection.appendChild(promptContent);

            card.appendChild(sceneNumber);
            card.appendChild(title);
            card.appendChild(body);
            card.appendChild(promptSection);
            resultsContainer.appendChild(card);
        });
        await translateUI(); //  <--- TRANSLATE HERE, after cards are created

        totalCards = storyboard.length;
        currentIndex = 0;
        updateNavigationButtons();

        resultsContainerWrapper.style.height = 'auto';

    } catch (error) {
        console.error('Error:', error);
        loadingContainer.style.display = 'none';
    }
}

        async function loadCreatorOptions() {
            try {
                const response = await fetch(`${window.API_BASE_URL}/getCreatorDNAs`);
                const creators = await response.json();
                const dropdownMenu = document.getElementById('creatorDropdown');
                dropdownMenu.innerHTML = '';

                const sortedCreatorNames = Object.keys(creators).sort((a, b) =>
                    a.toLowerCase().localeCompare(b.toLowerCase())
                );

                sortedCreatorNames.forEach(creatorName => {
                    const item = document.createElement('div');
                    item.className = 'creator-dropdown-item';
                    item.textContent = creatorName;
                    item.addEventListener('click', () => {
                        selectedCreatorDNA = creators[creatorName];
                        document.getElementById('creatorInput').value = creatorName;
                        dropdownMenu.classList.remove('active');
                    });
                    dropdownMenu.appendChild(item);
                });
            } catch (error) {
                console.error('Error loading creators:', error);
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {

            await translateUI();

    // Dropdown handling
    const dropdownArrow = document.getElementById('creatorDropdownArrow');
    const dropdownMenu = document.getElementById('creatorDropdown');

    dropdownArrow.addEventListener('click', async (e) => {
        e.stopPropagation();
        dropdownMenu.classList.toggle('active');
        if (dropdownMenu.classList.contains('active')) {
            await loadCreatorOptions();
        }
    });

    document.addEventListener('click', (e) => {
        if (!dropdownMenu.contains(e.target) && !dropdownArrow.contains(e.target)) {
            dropdownMenu.classList.remove('active');
        }
    });

    // Scrolling functionality
    const resultsContainer = document.querySelector('.storyboard-results');
    
    // Mousewheel scrolling
    resultsContainer.addEventListener('wheel', (e) => {
        e.preventDefault();
        resultsContainer.scrollLeft += e.deltaY + e.deltaX;
    }, { passive: false });

    // Touch/drag scrolling with improved sensitivity
    let isDown = false;
    let startX;
    let scrollLeft;
    let velocity = 0;
    const sensitivity = 2.5; // Increase this value to make scrolling more responsive

    resultsContainer.addEventListener('mousedown', (e) => {
        isDown = true;
        resultsContainer.style.cursor = 'grabbing';
        startX = e.pageX - resultsContainer.offsetLeft;
        scrollLeft = resultsContainer.scrollLeft;
        velocity = 0;
    });

    resultsContainer.addEventListener('mouseleave', () => {
        isDown = false;
        resultsContainer.style.cursor = 'default';
    });

    resultsContainer.addEventListener('mouseup', () => {
        isDown = false;
        resultsContainer.style.cursor = 'default';
    });

    resultsContainer.addEventListener('mousemove', (e) => {
        if (!isDown) return;
        e.preventDefault();
        const x = e.pageX - resultsContainer.offsetLeft;
        const walk = (x - startX) * sensitivity; // Apply sensitivity multiplier
        velocity = walk - resultsContainer.scrollLeft;
        resultsContainer.scrollLeft = scrollLeft - walk;
    });

    const urlParams = new URLSearchParams(window.location.search);
        const concept = urlParams.get('concept');
        const integration = urlParams.get('integration');
        const creator = urlParams.get('creator');

        if (concept && integration && creator) {
        // Set the concept
        document.getElementById('videoConcept').value = decodeURIComponent(concept);

        // Set the integration type
        document.getElementById('integrationType').value = integration;
        document.getElementById('integrationType').classList.remove('placeholder');

        // First, set creator input value
        document.getElementById('creatorInput').value = decodeURIComponent(creator);

        // Then load creator options and set selected creator
        loadCreatorOptions().then(async () => {
        // Get creator data
        const response = await fetch(`${window.API_BASE_URL}/getCreatorDNAs`);
        const creators = await response.json();

        // Set the selected creator DNA
        selectedCreatorDNA = creators[decodeURIComponent(creator)];

        // Generate the storyboard after a short delay
        setTimeout(() => {
            generateStoryboard();
        }, 500);
        });
        }
});

    // Handle placeholder state for integration select
    const integrationSelect = document.getElementById('integrationType');
    
    integrationSelect.addEventListener('change', function() {
        if (this.value) {
            this.classList.remove('placeholder');
        } else {
            this.classList.add('placeholder');
        }
    });
    </script>
</body>
</html>